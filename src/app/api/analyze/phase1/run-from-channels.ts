import type { SupabaseClient } from '@supabase/supabase-js';
import { categorizeChannels } from '@/lib/husband-match/analysis/categorize-channels';
import { calculateTCI } from '@/lib/husband-match/analysis/calculate-tci';
import { estimateEnneagram } from '@/lib/husband-match/analysis/estimate-enneagram';
import { estimateMBTI } from '@/lib/husband-match/analysis/estimate-mbti';
import { createVector } from '@/lib/husband-match/analysis/create-vector';
import { matchHusbandType } from '@/lib/husband-match/analysis/match-husband-type';
import {
  runYouTubeAnalysis,
  generateBarChart,
} from '@/lib/husband-match/analysis/youtube-analysis';
import { chatCompletion } from '@/lib/gemini-client';
import { SYSTEM_PROMPT } from '@/lib/husband-match/prompts/system-prompt';
import type { Phase1CardData } from '@/lib/husband-match/prompts/card-prompts';
import {
  ENNEAGRAM_NAMES,
  TCI_NAMES,
  getSortedCategories,
  getTopTCIScores,
  getBottomTCIScores,
  getTCICharacteristics,
} from '@/lib/husband-match/prompts/card-prompts';
import type { ReportCard, ChannelData, ChannelCategories, TCIScores } from '@/lib/husband-match/types';
import type { YouTubeCategoryResult, RarityAnalysis, YouTubeTCIScores } from '@/lib/husband-match/data/youtube-categories';
import { YOUTUBE_CATEGORY_NAMES, YOUTUBE_AVERAGE_RATIOS } from '@/lib/husband-match/data/youtube-categories';

// ì¹´ë“œ 1 ê³ ì • í…ìŠ¤íŠ¸ (í•­ìƒ ë™ì¼í•œ ë‚´ìš©)
const CARD_1_FIXED_CONTENT = `ìƒˆë²½ ë‘ ì‹œ, ì•„ë¬´ë„ ëª¨ë¥´ê²Œ ì¬ìƒí•œ ê·¸ ì˜ìƒ. ìŠµê´€ì²˜ëŸ¼ ëˆ„ë¥¸ êµ¬ë… ë²„íŠ¼, ì•Œê³ ë¦¬ì¦˜ì´ ìŠ¬ì© ê±´ë„¨ ì¶”ì²œ í•œ ì¤„.

ê±°ê¸°ì—” ë‹¹ì‹ ë„ ì˜ì‹í•˜ì§€ ëª»í•œ ìš•êµ¬ì™€ ê²°í•, ëŒë¦¼ì˜ ë°©í–¥ì´ ê³ ìŠ¤ë€íˆ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ìœ íŠœë¸ŒëŠ” ìƒê°ë³´ë‹¤ ì‚¬ì ì¸ ê³µê°„ì…ë‹ˆë‹¤. íƒ€ì¸ ì•ì—ì„œëŠ” ì‰½ê²Œ í¬ì¥í•˜ì§€ë§Œ, í˜¼ì ë³´ëŠ” í™”ë©´ ì•ì—ì„œë§Œí¼ì€ ëˆ„êµ¬ë‚˜ ê½¤ ì •ì§í•´ì§€ë‹ˆê¹Œìš”.

ì§€ê¸ˆë¶€í„° ë‹¹ì‹ ì˜ êµ¬ë… ì±„ë„ê³¼ ì‹œì²­ íŒ¨í„´ì„ ì°¬ì°¬íˆ ë“¤ì—¬ë‹¤ë³´ê² ìŠµë‹ˆë‹¤. ê·¸ ì•ˆì—ì„œ ë‹¹ì‹ ì˜ ì„±ê²© êµ¬ì¡°ì™€ ê´€ê³„ ìš•êµ¬ë¥¼ ì½ì–´ë‚´ê³ , í‰ìƒì˜ ë™ë°˜ìê°€ ë  ì‚¬ëŒì˜ ìœ í˜•ê³¼ êµ¬ì²´ì ì¸ í”„ë¡œí•„, ê·¸ë¦¬ê³  ì ˆëŒ€ ì°¸ì„ ìˆ˜ ì—†ëŠ” ìƒëŒ€ì˜ ë‹¨ì ê¹Œì§€ ì§šì–´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ì¤€ë¹„ë˜ì…¨ë‹¤ë©´, ì‹œì‘í•©ë‹ˆë‹¤.`;

// ì¹´ë“œ 11 ê³ ì • í…ìŠ¤íŠ¸ (CTA â€” LLMì´ ê°€ê²©/ë¸”ëŸ¬ íŒíŠ¸ë¥¼ ëˆ„ë½í•˜ë¯€ë¡œ ê³ ì •)
function getCard11FixedContent(channelCount: number): string {
  return `ì—¬ê¸°ê¹Œì§€ê°€ ë¬´ë£Œ ë¶„ì„ì´ì—ìš”.

ë‹¹ì‹ ì˜ êµ¬ë… ì±„ë„ ${channelCount}ê°œë¥¼ ë¶„ì„í•´ 11ì¥ì˜ ì¹´ë“œë¡œ ë‹¹ì‹ ì˜ ë‚´ë©´ì„ ë“¤ì—¬ë‹¤ë³´ì•˜ì–´ìš”.


**Phase 2ì—ì„œ ì•Œ ìˆ˜ ìˆëŠ” ê²ƒ**

ë” ê¹Šì€ ì´ì•¼ê¸°ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.

âœ¦ ì• ì¸ì´ ìƒê°í•˜ëŠ” ë‹¹ì‹ 
  â†’ "ì¡°ìš©í•œ ë°”ë‹¤ ê°™ì€ ì‚¬ëŒ â€” ê¹Šì´ë¥¼..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ë‹¹ì‹ ì´ ê²°í˜¼ì„ í™•ì‹ í•˜ê²Œ ë˜ëŠ” ìˆœê°„
  â†’ "ë‹¹ì‹ ì—ê²Œ ê²°í˜¼ì˜ í™•ì‹ ì€..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ì—°ì• ì—ì„œ ê²°í˜¼ìœ¼ë¡œ ëª» ê°€ëŠ” ì§„ì§œ ì´ìœ 
  â†’ "ë°˜ë³µë˜ëŠ” íŒ¨í„´ì´..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ë§Œì•½ ì´í˜¼í•œë‹¤ë©´, ê·¸ ì´ìœ ëŠ”...
  â†’ "ìœ„í—˜ ìš”ì¸ ë¶„ì„ ê²°ê³¼..." [ë¸”ëŸ¬ ì²˜ë¦¬]


**Phase 2 ì§„í–‰ ë°©ì‹**

1. 9ê°œì˜ ì‹¬ì¸µ ì§ˆë¬¸ì— ë‹µë³€
2. YouTube ë°ì´í„°ì™€ êµì°¨ ê²€ì¦
3. 8ì¥ì˜ ì‹¬ì¸µ ë¦¬í¬íŠ¸ ì¹´ë“œ ì œê³µ


**[ ì‹¬ì¸µ ë¶„ì„ ì‹œì‘í•˜ê¸° â€” â‚©4,900 ]**


* ë¶„ì„ ê²°ê³¼ëŠ” ì‹¬ë¦¬í•™ì  ì—°êµ¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì§€ë§Œ,
  ì‹¤ì œ ì‹¬ë¦¬ ê²€ì‚¬ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* ì¬ë¯¸ì™€ ìê¸° ì´í•´ë¥¼ ìœ„í•œ ì½˜í…ì¸ ë¡œ ì¦ê²¨ì£¼ì„¸ìš”.`;
}

// 11ì¥ ì¹´ë“œ íƒ€ì´í‹€ (NEW: ì¹´ë“œ 3,4 ì¶”ê°€)
const CARD_TITLES: Record<number, { title: string; subtitle?: string; card_type: ReportCard['card_type'] }> = {
  1: { title: 'ë‹¹ì‹ ì´ ëª°ë˜ ë³¸ ì˜ìƒì´, ë‹¹ì‹ ì„ ë§í•˜ê³  ìˆë‹¤', subtitle: 'INTRO', card_type: 'intro' },
  2: { title: '', subtitle: 'êµ¬ë… ë°ì´í„° ê°œìš”', card_type: 'intro' }, // titleì€ LLMì´ ìƒì„±
  3: { title: '', subtitle: 'Your Subscription DNA', card_type: 'personality' }, // êµ¬ë… ì¹´í…Œê³ ë¦¬ ë­í‚¹ (NEW)
  4: { title: 'ë‹¹ì‹ ì—ê²Œì„œ ë°œê²¬í•œ íŠ¹ë³„í•œ ì·¨í–¥', subtitle: 'Hidden Gem in Your List', card_type: 'personality' }, // í¬ê·€ ì·¨í–¥ (NEW)
  5: { title: '', subtitle: '', card_type: 'personality' }, // í†µí•© ìœ í˜• ë¶„ì„
  6: { title: 'ë‹¹ì‹ ì˜ ê°ì„±', subtitle: 'ê°ì • ìŠ¤íƒ€ì¼', card_type: 'values' },
  7: { title: 'ì¶”êµ¬í•˜ëŠ” ë¯¸ë˜', subtitle: 'ë¯¸ë˜ìƒ', card_type: 'values' },
  8: { title: 'ê²¬ë””ê¸° í˜ë“  ìƒëŒ€ë°©ì˜ ë‹¨ì ', subtitle: 'ê´€ê³„ ì¸ì‚¬ì´íŠ¸', card_type: 'values' },
  9: { title: 'ë‹¹ì‹ ì˜ ì™•ìë‹˜ì€', subtitle: 'ë§¤ì¹­ ê²°ê³¼', card_type: 'matching' },
  10: { title: 'ì™•ìë‹˜ ìƒì„¸ í”„ë¡œí•„', subtitle: 'íŒŒíŠ¸ë„ˆ í”„ë¡œí•„', card_type: 'matching' },
  11: { title: 'ë” ê¹Šì€ ë¶„ì„ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?', subtitle: 'Phase 2 ì•ˆë‚´', card_type: 'result' },
};

function formatCategoriesForPrompt(categories: ChannelCategories): string {
  const sorted = getSortedCategories(categories);
  return sorted.slice(0, 5).map(c => `${c.name}(${c.count}ê°œ, ${c.percent}%)`).join(', ') || 'ì—†ìŒ';
}

function formatTCIScores(tci: TCIScores): string {
  return Object.entries(tci)
    .map(([key, value]) => `${TCI_NAMES[key as keyof TCIScores]}(${key})=${value}`)
    .join(', ');
}

// MBTI íŠ¹ì„± í…ìŠ¤íŠ¸ ìƒì„±
function getMBTITraits(scores: Phase1CardData['mbti_scores']): string[] {
  const traits: string[] = [];
  traits.push(scores.E > scores.I ? 'ì‚¬ëŒë“¤ê³¼ì˜ êµë¥˜ì—ì„œ ì—ë„ˆì§€ë¥¼ ì–»ëŠ”' : 'í˜¼ìë§Œì˜ ì‹œê°„ì—ì„œ ì—ë„ˆì§€ë¥¼ ì¶©ì „í•˜ëŠ”');
  traits.push(scores.S > scores.N ? 'í˜„ì‹¤ì ì´ê³  êµ¬ì²´ì ì¸ ê²ƒì„ ì„ í˜¸í•˜ëŠ”' : 'ê°€ëŠ¥ì„±ê³¼ ì•„ì´ë””ì–´ë¥¼ íƒêµ¬í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ëŠ”');
  traits.push(scores.T > scores.F ? 'ë…¼ë¦¬ì ì´ê³  ê°ê´€ì ì¸ íŒë‹¨ì„ ì¤‘ì‹œí•˜ëŠ”' : 'ì‚¬ëŒê³¼ ê°€ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê²°ì •í•˜ëŠ”');
  traits.push(scores.J > scores.P ? 'ê³„íšì ì´ê³  ì²´ê³„ì ì¸ ê²ƒì„ ì„ í˜¸í•˜ëŠ”' : 'ìœ ì—°í•˜ê³  ì¦‰í¥ì ì¸ ê²ƒì„ ì¦ê¸°ëŠ”');
  return traits;
}

// ì• ë‹ˆì–´ê·¸ë¨ íŠ¹ì„± í…ìŠ¤íŠ¸
function getEnneagramTrait(type: number): string {
  const traits: Record<number, string> = {
    1: 'ì™„ë²½ì„ ì¶”êµ¬í•˜ê³  ì›ì¹™ì„ ì¤‘ìš”ì‹œí•˜ëŠ” ì„±í–¥',
    2: 'íƒ€ì¸ì„ ë•ê³  ê´€ê³„ë¥¼ ì¤‘ìš”ì‹œí•˜ëŠ” ë”°ëœ»í•œ ì„±í–¥',
    3: 'ì„±ì·¨ì™€ ì¸ì •ì„ ì¶”êµ¬í•˜ë©° ëª©í‘œ ì§€í–¥ì ì¸ ì„±í–¥',
    4: 'ìì‹ ë§Œì˜ ë…íŠ¹í•¨ê³¼ ê¹Šì€ ê°ì •ì„ ì¤‘ìš”ì‹œí•˜ëŠ” ì„±í–¥',
    5: 'ì§€ì‹ê³¼ ì´í•´ë¥¼ ì¶”êµ¬í•˜ë©° ë…ë¦½ì ì¸ ì„±í–¥',
    6: 'ì•ˆì „ê³¼ ì‹ ë¢°ë¥¼ ì¤‘ìš”ì‹œí•˜ë©° ì¶©ì„±ìŠ¤ëŸ¬ìš´ ì„±í–¥',
    7: 'ì¦ê±°ì›€ê³¼ ë‹¤ì–‘í•œ ê²½í—˜ì„ ì¶”êµ¬í•˜ëŠ” í™œë°œí•œ ì„±í–¥',
    8: 'í˜ê³¼ í†µì œë¥¼ ì¤‘ìš”ì‹œí•˜ë©° ë„ì „ì ì¸ ì„±í–¥',
    9: 'í‰í™”ì™€ ì¡°í™”ë¥¼ ì¶”êµ¬í•˜ë©° ìˆ˜ìš©ì ì¸ ì„±í–¥',
  };
  return traits[type] || traits[9];
}

// Extended card data with YouTube analysis
interface ExtendedCardData extends Phase1CardData {
  youtubeCategories: YouTubeCategoryResult[];
  rarity: RarityAnalysis;
  youtubeTCI: YouTubeTCIScores;
  topBottom: {
    top1: { axis: string; score: number; name: string };
    top2: { axis: string; score: number; name: string };
    bottom: { axis: string; score: number; name: string };
  };
}

// ê³µìœ  ë¶„ì„ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸ ìƒì„±
function buildAnalysisContext(data: ExtendedCardData): string {
  const ennea = data.enneagram_type ?? 9;
  const enneaName = ENNEAGRAM_NAMES[ennea];
  const h = data.matched_husband;
  const scorePercent = Math.round(data.match_score * 100);
  const mbtiTraits = getMBTITraits(data.mbti_scores);
  const ytCats = data.youtubeCategories;
  const rarity = data.rarity;
  const topBottom = data.topBottom;
  const tci = data.youtubeTCI;

  return `## ë¶„ì„ ë°ì´í„°

### êµ¬ë… ì±„ë„ ì •ë³´
- ì´ ì±„ë„ ìˆ˜: ${data.channelCount}ê°œ
- YouTube ì¹´í…Œê³ ë¦¬ ë¶„í¬:
${ytCats.map(c => `  Â· ${c.name}: ${c.count}ê°œ (${c.percent}%)`).join('\n')}

### í¬ì†Œì„± ë¶„ì„
- ìƒìœ„ ${rarity.percentile}% (ì½”ì‚¬ì¸ ìœ ì‚¬ë„: ${rarity.cosineSimilarity.toFixed(2)})
- ê°€ì¥ í¬ê·€í•œ ì¹´í…Œê³ ë¦¬: ${rarity.rarestCategoryName} (ì‚¬ìš©ì ë¹„ìœ¨ ${rarity.rarestCategoryPercent}%)
- í•´ë‹¹ ì±„ë„: ${rarity.rarestCategoryChannels.join(', ')}

### ì‹¬ë¦¬ ë¶„ì„ 6ì¶• (ì •ê·œí™” 0-100ì )
- 1ìœ„: ${topBottom.top1.name} ${topBottom.top1.score}ì 
- 2ìœ„: ${topBottom.top2.name} ${topBottom.top2.score}ì 
- ìµœì €: ${topBottom.bottom.name} ${topBottom.bottom.score}ì 
- ì „ì²´: ìê¸°ì´ˆì›”(ST)=${tci.ST}, ììœ¨ì„±(SD)=${tci.SD}, ìê·¹ì¶”êµ¬(NS)=${tci.NS}, ìœ„í—˜íšŒí”¼(HA)=${tci.HA}, ì¸ë‚´ë ¥(P)=${tci.P}, ì—°ëŒ€ê°(CO)=${tci.CO}

### ì„±ê²© ìœ í˜•
- ì• ë‹ˆì–´ê·¸ë¨: ${ennea}ë²ˆ (${enneaName})
- MBTI: ${data.mbti_type}
- MBTI íŠ¹ì„±: ${mbtiTraits.join(', ')}

### ë§¤ì¹­ëœ ë‚¨í¸ ìœ í˜•
- ìœ í˜•ëª…: ${h.name}
- ì¹´í…Œê³ ë¦¬: ${h.category} > ${h.subcategory}
- ì„±í–¥: ${h.variant === 'extrovert' ? 'ì™¸í–¥í˜•' : 'ë‚´í–¥í˜•'}
- ì„±ê²© ì„¤ëª…: ${h.description}
- ë¹„ìœ (ì™¸í–¥): ${h.metaphor_e || 'ì—†ìŒ'}
- ë¹„ìœ (ë‚´í–¥): ${h.metaphor_i || 'ì—†ìŒ'}
- ë§¤ì¹­ ì ìˆ˜: ${scorePercent}%`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 4ë°°ì¹˜ ì¹´ë“œ ìƒì„± (max_tokens 8192, few-shot ì˜ˆì‹œ í¬í•¨)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const LLM_OPTIONS = { model: 'gpt-4o-mini', temperature: 0.7, max_tokens: 8192, response_format: { type: 'json_object' as const } };

// ë°°ì¹˜ A: ì¹´ë“œ 2, 3 (êµ¬ë… ë°ì´í„° ê°œìš” + ì¹´í…Œê³ ë¦¬ ë­í‚¹)
async function generateBatchA(data: ExtendedCardData, context: string): Promise<Record<string, string>> {
  const ytCats = data.youtubeCategories;
  const rarity = data.rarity;

  const prompt = `ì•„ë˜ ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 2ê°œì˜ ë¦¬í¬íŠ¸ ì¹´ë“œ ë‚´ìš©ì„ JSONìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

## âš ï¸ í•„ìˆ˜: ê° ì¹´ë“œëŠ” ë°˜ë“œì‹œ 1,500ì ì´ìƒ 2,000ì ì´í•˜ë¡œ ì‘ì„±í•˜ì„¸ìš”. 500ì ì´í•˜ì˜ ì§§ì€ ì‘ë‹µì€ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.

${context}

## ì¹´ë“œ 2: êµ¬ë… ë°ì´í„° ê°œìš”
- "2_title": ì‚¬ìš©ìì˜ êµ¬ë… íŒ¨í„´ì„ í•œ ì¤„ë¡œ ìš”ì•½í•˜ëŠ” ë§ˆì¼€íŒ… ì¹´í”¼ (ì˜ˆ: "ë‹¹ì‹ ì€ ${ytCats[0]?.name || 'ë‹¤ì–‘í•œ ê²½í—˜'}ì„ í†µí•´ ì„¸ìƒì„ íƒí—˜í•˜ëŠ” ì·¨í–¥ì„ ì§€ë‹ˆì…¨êµ°ìš”")
- "2": ë³¸ë¬¸ (1500-2000ì) â€” ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **"ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ê°€ ë§í•´ì£¼ëŠ” ê²ƒ"** â€” ì´ ì±„ë„ ìˆ˜, ì¹´í…Œê³ ë¦¬ ìˆ˜, ìƒìœ„ 3ê°œ ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨ ë¶„ì„
  2) **"ìœ¡ê°í˜• ë°¸ëŸ°ìŠ¤ì—ì„œ ë“œëŸ¬ë‚œ ë‹¹ì‹ ì˜ íŠ¹ì„±"** â€” 6ì¶• ì ìˆ˜ë¥¼ ê°ê° í•œ ì¤„ì”© ì„¤ëª… (ì ìˆ˜ ì¸ìš© í•„ìˆ˜)
  3) **"ê°€ì¥ ë‘ë“œëŸ¬ì§„ ì¶•: {1ìœ„ ì¶•ëª…} ({ì ìˆ˜}ì )"** â€” ì™œ ì´ ì¶•ì´ ë†’ì€ì§€, êµ¬ë… ì¹´í…Œê³ ë¦¬ì™€ ì—°ê²°
  4) **"ì™œ ì´ë ‡ê²Œ ë¶„ì„í–ˆëŠ”ì§€"** â€” êµ¬ë… ë¹„ìœ¨ â†’ TCI ì ìˆ˜ ì—°ê²° ê·¼ê±° 2-3ê°œ

[ì˜ˆì‹œ â€” ì´ ìˆ˜ì¤€ì˜ êµ¬ì²´ì„±ê³¼ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”]
"""
**ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ê°€ ë§í•´ì£¼ëŠ” ê²ƒ**

ì´ 45ê°œì˜ ì±„ë„ì„ ë¶„ì„í•œ ê²°ê³¼, 8ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ê³„ì‹  ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”.

ê°€ì¥ ë§ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” ë¶„ì•¼ëŠ” "êµìœ¡/ìê¸°ê³„ë°œ"ìœ¼ë¡œ, ì „ì²´ì˜ 28%ë¥¼ ì°¨ì§€í•˜ê³  ìˆì–´ìš”. ë‘ ë²ˆì§¸ëŠ” "ë¸Œì´ë¡œê·¸/ì¼ìƒ"(22%), ì„¸ ë²ˆì§¸ëŠ” "ìŒì•…"(15%)ì…ë‹ˆë‹¤.

ì´ ì¡°í•©ì€ ë‹¨ìˆœíˆ "ì´ëŸ° ì˜ìƒì„ ì¢‹ì•„í•œë‹¤"ëŠ” ê²ƒì„ ë„˜ì–´, ë‹¹ì‹ ì´ ë¬´ì˜ì‹ì ìœ¼ë¡œ ì¶”êµ¬í•˜ëŠ” ê°€ì¹˜ì™€ ìš•êµ¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.


**ìœ¡ê°í˜• ë°¸ëŸ°ìŠ¤ì—ì„œ ë“œëŸ¬ë‚œ ë‹¹ì‹ ì˜ íŠ¹ì„±**

ë‹¹ì‹ ì˜ êµ¬ë… ë°ì´í„°ë¥¼ 6ê°€ì§€ ì‹¬ë¦¬ì  ì¶•ìœ¼ë¡œ ë¶„ì„í•´ë³´ì•˜ì–´ìš”:

â€¢ ìê¸°ì´ˆì›”: 72ì  - ì‚¶ì˜ ì˜ë¯¸ì™€ ê¹Šì´ë¥¼ ì¶”êµ¬í•˜ëŠ” ì •ë„
â€¢ ììœ¨ì„±: 85ì  - ìŠ¤ìŠ¤ë¡œ ê²°ì •í•˜ê³  ì´ëŒì–´ê°€ë ¤ëŠ” ì„±í–¥
(... 6ì¶• ëª¨ë‘ ì ìˆ˜ì™€ í•¨ê»˜ ì„œìˆ  ...)


**ê°€ì¥ ë‘ë“œëŸ¬ì§„ ì¶•: ììœ¨ì„± (85ì )**

ë‹¹ì‹ ì—ê²Œì„œ ê°€ì¥ ê°•í•˜ê²Œ ë‚˜íƒ€ë‚˜ëŠ” íŠ¹ì„±ì€ "ììœ¨ì„±"ì´ì—ìš”. ì´ íŠ¹ì„±ì´ êµìœ¡/ìê¸°ê³„ë°œ ì±„ë„ì„ 28%ë‚˜ êµ¬ë…í•˜ê²Œ ë§Œë“  ì´ìœ ì´ê¸°ë„ í•´ìš”.
(... ì´ì–´ì„œ 2ìœ„ ì¶•ê³¼ì˜ ì‹œë„ˆì§€, ê·¼ê±° ì„¹ì…˜ê¹Œì§€ ...)
"""

## ì¹´ë“œ 3: êµ¬ë… ì¹´í…Œê³ ë¦¬ ë­í‚¹
- "3_title": "ë‹¹ì‹ ì˜ êµ¬ë… ì·¨í–¥ì€ ìƒìœ„ ${rarity.percentile}%ì—ìš”"
- "3": ë³¸ë¬¸ (1500-2000ì) â€” ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **"ë‹¹ì‹ ì˜ ì„¸ìƒì€ ì˜¨í†µ ${ytCats[0]?.name || 'ë‹¤ì–‘í•¨'}(ìœ¼)ë¡œ ê°€ë“í•´ìš”"** â€” ì²« ë¬¸ì¥
  2) ì´ ${data.channelCount}ê°œ ì±„ë„ ì¤‘ ì¹´í…Œê³ ë¦¬ ë­í‚¹ (1ìœ„~5ìœ„), ê°ê° ì˜ë¯¸ í•´ì„
  3) 1ìœ„ì™€ 2ìœ„ ì¡°í•©ì˜ ì˜ë¯¸
  4) ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ${rarity.cosineSimilarity.toFixed(2)} ê¸°ë°˜ í¬ì†Œì„± í•´ì„
  5) Spotify Wrapped ìŠ¤íƒ€ì¼ì˜ ì„íŒ©íŠ¸ ìˆëŠ” ë¬¸ì²´

## ì‘ë‹µ í˜•ì‹ (JSONë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´)
{
  "2_title": "íƒ€ì´í‹€ ë¬¸ìì—´",
  "2": "ë³¸ë¬¸ 1500ì ì´ìƒ",
  "3_title": "ë‹¹ì‹ ì˜ êµ¬ë… ì·¨í–¥ì€ ìƒìœ„ ${rarity.percentile}%ì—ìš”",
  "3": "ë³¸ë¬¸ 1500ì ì´ìƒ"
}`;

  const response = await chatCompletion(
    [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: prompt },
    ],
    LLM_OPTIONS
  );

  return JSON.parse(response ?? '{}');
}

// ë°°ì¹˜ B: ì¹´ë“œ 4, 5 (í¬ê·€ ì·¨í–¥ + ìœ í˜• ë¶„ì„)
async function generateBatchB(data: ExtendedCardData, context: string): Promise<Record<string, string>> {
  const rarity = data.rarity;
  const topBottom = data.topBottom;

  const prompt = `ì•„ë˜ ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 2ê°œì˜ ë¦¬í¬íŠ¸ ì¹´ë“œ ë‚´ìš©ì„ JSONìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

## âš ï¸ í•„ìˆ˜: ê° ì¹´ë“œëŠ” ë°˜ë“œì‹œ 1,500ì ì´ìƒ 2,000ì ì´í•˜ë¡œ ì‘ì„±í•˜ì„¸ìš”. 500ì ì´í•˜ì˜ ì§§ì€ ì‘ë‹µì€ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.

${context}

## ì¹´ë“œ 4: í¬ê·€ ì·¨í–¥ ë¶„ì„
- "4": ë³¸ë¬¸ (1500-2000ì) â€” ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **"ê°€ì¥ í¬ê·€í•œ êµ¬ë… ì¹´í…Œê³ ë¦¬: ${rarity.rarestCategoryName}"** â€” ë„ì…ë¶€
  2) "ì´ ì¹´í…Œê³ ë¦¬ë¥¼ êµ¬ë…í•˜ëŠ” ì‚¬ìš©ìëŠ” ì „ì²´ì˜ ${rarity.rarestCategoryPercent}%ì— ë¶ˆê³¼í•´ìš”"
  3) í•´ë‹¹ ì±„ë„ ë¦¬ìŠ¤íŠ¸: ${rarity.rarestCategoryChannels.join(', ')}
  4) **"ì´ ì·¨í–¥ì´ ë§í•´ì£¼ëŠ” ë‹¹ì‹ ì˜ ì‹¬ë¦¬"** â€” ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì¦ê¸°ëŠ” ì‚¬ëŒì˜ ì‹¬ë¦¬ì  íŠ¹ì„± 2-3ë¬¸ë‹¨
  5) **"ë‹¹ì‹ ë§Œì˜ ì‹œê·¸ë‹ˆì²˜"** â€” "${data.channelCount}ê°œ ì±„ë„ ì¤‘ ë‹¨ ${rarity.rarestCategoryChannels.length}ê°œ. ê·¸ê²Œ ë‹¹ì‹ ì˜ ì‹œê·¸ë‹ˆì²˜ì˜ˆìš”."

## ì¹´ë“œ 5: í†µí•© ìœ í˜• ë¶„ì„
- "5_subtitle": ì˜ì–´ íƒ€ì…ëª… 3-5ë‹¨ì–´ (ì˜ˆ: "Adventurous Social Explorer Type")
- "5_title": "ë‹¹ì‹ ì€ {í•œêµ­ì–´ íƒ€ì… ì´ë¦„} íƒ€ì…ì´ì—ìš”"
  Â· ${topBottom.top1.name}(1ìœ„) + ${topBottom.top2.name}(2ìœ„) + ${topBottom.bottom.name}(ìµœì €) ì¡°í•© ê¸°ë°˜
  Â· ì˜ˆ: ìê·¹ì¶”êµ¬(1ìœ„) + ì—°ëŒ€ê°(2ìœ„) + ìœ„í—˜íšŒí”¼(ìµœì €) â†’ "ê±°ì¹¨ì—†ëŠ” ì‚¬êµí˜• íƒí—˜ê°€"
- "5": ë³¸ë¬¸ (1500-2000ì) â€” ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) í•´ì‹œíƒœê·¸ 3ê°œ (ì˜ˆ: #ìê·¹ì¶”êµ¬ #ì—°ëŒ€ê° #ìê¸°ì´í•´)
  2) **"ë‹¹ì‹ ì˜ í•µì‹¬ íŠ¹ì„±: {1ìœ„}ê³¼ {2ìœ„}ì˜ ì¡°í™”"** â€” 1ìœ„ ì¶• ì ìˆ˜ì™€ ì˜ë¯¸, 2ìœ„ì™€ì˜ ì‹œë„ˆì§€
  3) **"ê´€ê³„ì—ì„œ ë³´ì´ëŠ” íŒ¨í„´"** â€” MBTI íŠ¹ì„± ì—°ê²° (ëª…ì¹­ ê¸ˆì§€, íŠ¹ì§•ë§Œ)
  4) **"ìˆ¨ê²¨ì§„ ìš•êµ¬"** â€” ìµœì € ì¶•ì´ ì˜ë¯¸í•˜ëŠ” ê²°í•/ê°ˆë§
  5) **"ì™œ ì´ë ‡ê²Œ ë¶„ì„í–ˆëŠ”ì§€"** â€” ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨ â†’ ì¶• ì ìˆ˜ ì—°ê²° ê·¼ê±°
  Â· âš ï¸ MBTI/ì• ë‹ˆì–´ê·¸ë¨ ìœ í˜•ëª…(ì˜ˆ: INFP, 4ë²ˆ ìœ í˜•) ì ˆëŒ€ ì–¸ê¸‰ ê¸ˆì§€. íŠ¹ì„±ë§Œ ì„œìˆ .

## ì‘ë‹µ í˜•ì‹ (JSONë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´)
{
  "4": "ë³¸ë¬¸ 1500ì ì´ìƒ",
  "5_subtitle": "English Type Name",
  "5_title": "ë‹¹ì‹ ì€ {íƒ€ì…} íƒ€ì…ì´ì—ìš”",
  "5": "ë³¸ë¬¸ 1500ì ì´ìƒ"
}`;

  const response = await chatCompletion(
    [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: prompt },
    ],
    LLM_OPTIONS
  );

  return JSON.parse(response ?? '{}');
}

// ë°°ì¹˜ C: ì¹´ë“œ 6, 7, 8 (ê°ì„±, ë¯¸ë˜, ë‹¨ì )
async function generateBatchC(data: ExtendedCardData, context: string): Promise<Record<string, string>> {
  const tci = data.youtubeTCI;
  const topBottom = data.topBottom;
  const ytCats = data.youtubeCategories;

  const prompt = `ì•„ë˜ ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 3ê°œì˜ ë¦¬í¬íŠ¸ ì¹´ë“œ ë‚´ìš©ì„ JSONìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

## âš ï¸ í•„ìˆ˜: ê° ì¹´ë“œëŠ” ë°˜ë“œì‹œ 1,500ì ì´ìƒ 2,000ì ì´í•˜ë¡œ ì‘ì„±í•˜ì„¸ìš”. 500ì ì´í•˜ì˜ ì§§ì€ ì‘ë‹µì€ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.

${context}

## ì¹´ë“œ 6: ë‹¹ì‹ ì˜ ê°ì„± (1500-2000ì)
- "6": ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **ê°ì„± ìœ í˜• í•œ ì¤„ ì •ì˜** (ì˜ˆ: "ë§ˆìŒì„ ë‚˜ëˆ„ë©° íë§í•˜ëŠ” ì‚¬ëŒ" / "ì¡°ìš©íˆ ì •ë¦¬í•˜ë©° íë§í•˜ëŠ” ì‚¬ëŒ")
     Â· ì—°ëŒ€ê°(CO)=${tci.CO}, ìœ„í—˜íšŒí”¼(HA)=${tci.HA} ê¸°ë°˜ íŒë‹¨
  2) **"ê°ì • ì²˜ë¦¬ ë°©ì‹"** â€” í˜ë“¤ ë•Œ ì–´ë–»ê²Œ í•˜ëŠ”ì§€, ê°ì • í‘œí˜„ ê²½í–¥
  3) **"ë‹¹ì‹ ë§Œì˜ íë§ íŒ¨í„´"** â€” ì²´í¬ë¦¬ìŠ¤íŠ¸ 5ê°œ (âœ“ í˜•ì‹, êµ¬ë… ì¹´í…Œê³ ë¦¬ ì—°ê²°)
     Â· ì˜ˆ: ${ytCats.find(c => c.category === 'music') ? 'ìŒì•… ì±„ë„ êµ¬ë… â†’ ìŒì•…ìœ¼ë¡œ ê°ì • ì¡°ì ˆ' : 'ë‹¤ì–‘í•œ ì½˜í…ì¸  â†’ ê¸°ë¶„ ì „í™˜'}
  4) **"ì´ê±´ ì•½ì ì´ ì•„ë‹ˆì—ìš”"** â€” ë¦¬í”„ë ˆì´ë°
  5) **"ê·¼ê±°"** â€” TCI ì ìˆ˜ + êµ¬ë… ë¹„ìœ¨ ì¸ìš©

## ì¹´ë“œ 7: ì¶”êµ¬í•˜ëŠ” ë¯¸ë˜ (1500-2000ì)
- "7": ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **ë¯¸ë˜ìƒ í•œ ì¤„ ì •ì˜** (ì˜ˆ: "ììœ ë¡­ê²Œ ì¼í•˜ë©° ì˜ë¯¸ ìˆëŠ” ì‚¶")
     Â· ììœ¨ì„±(SD)=${tci.SD}, ìê¸°ì´ˆì›”(ST)=${tci.ST} ê¸°ë°˜
  2) **"3ì¶• ë¶„ì„"** â€” ë¼ì´í”„ìŠ¤íƒ€ì¼/ì»¤ë¦¬ì–´/ê´€ê³„ ê°ê° 5ë‹¨ê³„ ì‹œê°í™”
  3) **"ë¯¸ë˜ì˜ ì–´ëŠ ì €ë…"** â€” êµ¬ì²´ì ì¸ ì¥ë©´ ë¬˜ì‚¬ (3ë¬¸ë‹¨)
  4) **"ì‹¬ë¦¬ íŠ¹ì„±ì´ ë§í•´ì£¼ëŠ” ìš•êµ¬"** â€” 1ìœ„/2ìœ„ ì¶• ì—°ê²°
  5) **"ê·¼ê±°"** â€” êµ¬ë… ì¹´í…Œê³ ë¦¬ì™€ ë¯¸ë˜ê´€ ì—°ê²°

## ì¹´ë“œ 8: ê²¬ë””ê¸° í˜ë“  ìƒëŒ€ë°©ì˜ ë‹¨ì  (1500-2000ì)
- "8": ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) âš ï¸ í•œ ì¤„ ìš”ì•½ (ì˜ˆ: "í”¼ìƒì ì´ê³  ê¹Šì´ ì—†ëŠ” ëŒ€í™”")
     Â· ${topBottom.top1.name} ë†’ìŒ â†’ ë°˜ëŒ€ íŠ¹ì„±ì— ë¯¼ê°
  2) **"ì™œ ì´ê²ƒì´ í˜ë“ ê°€ìš”?"** â€” 3ë¬¸ë‹¨ ì„œìˆ  + ìƒí™© ì˜ˆì‹œ
  3) **"êµ¬ì²´ì  ìƒí™© ì˜ˆì‹œ"** â€” í‘œ í˜•ì‹ 2ê°œ (í˜ë“  ìƒí™© | ë‹¹ì‹ ì˜ ë‚´ë©´)
  4) **"ì´ê±´ ì•½ì ì´ ì•„ë‹ˆì—ìš”"** â€” ë¦¬í”„ë ˆì´ë° + ì¡°ì–¸
  5) **"ê·¼ê±°"** â€” ${topBottom.top1.name} ${topBottom.top1.score}ì , ${topBottom.bottom.name} ${topBottom.bottom.score}ì  ì¸ìš©

## ì‘ë‹µ í˜•ì‹ (JSONë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´)
{
  "6": "ë³¸ë¬¸ 1500ì ì´ìƒ",
  "7": "ë³¸ë¬¸ 1500ì ì´ìƒ",
  "8": "ë³¸ë¬¸ 1500ì ì´ìƒ"
}`;

  const response = await chatCompletion(
    [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: prompt },
    ],
    LLM_OPTIONS
  );

  return JSON.parse(response ?? '{}');
}

// ë°°ì¹˜ D: ì¹´ë“œ 9, 10 (ì™•ìë‹˜ + ìƒì„¸ í”„ë¡œí•„ â€” ì¹´ë“œ 11ì€ ê³ ì • í…ìŠ¤íŠ¸)
async function generateBatchD(data: ExtendedCardData, context: string): Promise<Record<string, string>> {
  const h = data.matched_husband;
  const topBottom = data.topBottom;
  const scorePercent = Math.round(data.match_score * 100);

  const prompt = `ì•„ë˜ ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 2ê°œì˜ ë¦¬í¬íŠ¸ ì¹´ë“œ ë‚´ìš©ì„ JSONìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

## âš ï¸ í•„ìˆ˜: ê° ì¹´ë“œëŠ” ë°˜ë“œì‹œ 1,500ì ì´ìƒ 2,000ì ì´í•˜ë¡œ ì‘ì„±í•˜ì„¸ìš”. 500ì ì´í•˜ì˜ ì§§ì€ ì‘ë‹µì€ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.

${context}

## ì¹´ë“œ 9: ë‹¹ì‹ ì˜ ì™•ìë‹˜ì€ (1500-2000ì)
- "9": ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **í° ë¹„ìœ  ë¬¸êµ¬** â€” "${h.variant === 'extrovert' ? (h.metaphor_e || '') : (h.metaphor_i || '')}" í™œìš©
  2) **"${h.category} - ${h.subcategory}"** â€” ìœ í˜• ì¹´í…Œê³ ë¦¬ ì†Œê°œ
  3) **ìœ í˜• ì„¤ëª…** â€” "${h.description}" ê¸°ë°˜ìœ¼ë¡œ í’ë¶€í•˜ê²Œ ì„œìˆ 
  4) **"ì²˜ìŒ ë§Œë‚¬ì„ ë•Œ"** â€” ì²« ë§Œë‚¨ ì¥ë©´ ìƒìƒ (ì™¸í–¥/ë‚´í–¥ì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
     Â· ì„±í–¥: ${h.variant === 'extrovert' ? 'ì™¸í–¥í˜• â€” ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ì—ë„ˆì§€' : 'ë‚´í–¥í˜• â€” ì¡°ìš©í•˜ì§€ë§Œ ê¹Šì´ ìˆëŠ” ì¸ìƒ'}
  5) **"ì™œ ì´ ìœ í˜•ì¸ê°€ìš”?"** â€” ${topBottom.top1.name} ${topBottom.top1.score}ì  â†’ ì´ ìœ í˜•ê³¼ì˜ ìƒì„± ì„¤ëª…
  6) **"ê·¼ê±°"** â€” ë§¤ì¹­ ì ìˆ˜ ${scorePercent}%, í•µì‹¬ ì¶• ì—°ê²°

## ì¹´ë“œ 10: ì™•ìë‹˜ ìƒì„¸ í”„ë¡œí•„ (1500-2000ì)
- "10": ì•„ë˜ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ í¬í•¨:
  1) **"ê¸°ë³¸ ì •ë³´"** â€” ìœ í˜•ëª…: ${h.name}, ì¹´í…Œê³ ë¦¬: ${h.category} > ${h.subcategory}, ì„±í–¥: ${h.variant === 'extrovert' ? 'ì™¸í–¥í˜•' : 'ë‚´í–¥í˜•'}, ë§¤ì¹­ ì ìˆ˜: ${scorePercent}%
  2) **"ì´ëŸ° ë¶„ì´ì—ìš”"** â€” ${h.description} ê¸°ë°˜ 2ë¬¸ë‹¨ í™•ì¥
  3) **"í•¨ê»˜í•˜ë©´ ì´ëŸ° ëª¨ìŠµì´ì—ìš”"** â€” 3ê°œ êµ¬ì²´ì  ì¥ë©´:
     Â· ã€ì¥ë©´ 1ã€‘ ì£¼ë§ ì˜¤í›„
     Â· ã€ì¥ë©´ 2ã€‘ í˜ë“  ë‚ 
     Â· ã€ì¥ë©´ 3ã€‘ íŠ¹ë³„í•œ ë‚ 
  4) **"ì•Œì•„ë‘ì„¸ìš”"** â€” ì´ ìœ í˜•ê³¼ ì˜ ì§€ë‚´ê¸° ìœ„í•œ íŒ

## ì‘ë‹µ í˜•ì‹ (JSONë§Œ, ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´)
{
  "9": "ë³¸ë¬¸ 1500ì ì´ìƒ",
  "10": "ë³¸ë¬¸ 1500ì ì´ìƒ"
}`;

  const response = await chatCompletion(
    [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: prompt },
    ],
    LLM_OPTIONS
  );

  return JSON.parse(response ?? '{}');
}

// 4ë°°ì¹˜ ë³‘ë ¬ í˜¸ì¶œë¡œ ì¹´ë“œ ì½˜í…ì¸  ìƒì„±
async function generateAllCardsAtOnce(data: ExtendedCardData): Promise<Record<string, string>> {
  const context = buildAnalysisContext(data);

  const [batchA, batchB, batchC, batchD] = await Promise.all([
    generateBatchA(data, context).catch((err) => {
      console.error('[Phase 1] Batch A (cards 2-3) failed:', err);
      return {} as Record<string, string>;
    }),
    generateBatchB(data, context).catch((err) => {
      console.error('[Phase 1] Batch B (cards 4-5) failed:', err);
      return {} as Record<string, string>;
    }),
    generateBatchC(data, context).catch((err) => {
      console.error('[Phase 1] Batch C (cards 6-8) failed:', err);
      return {} as Record<string, string>;
    }),
    generateBatchD(data, context).catch((err) => {
      console.error('[Phase 1] Batch D (cards 9-10) failed:', err);
      return {} as Record<string, string>;
    }),
  ]);

  return { ...batchA, ...batchB, ...batchC, ...batchD };
}

// í´ë°±: í…œí”Œë¦¿ ê¸°ë°˜ ì¹´ë“œ ìƒì„± (11ì¥)
function generateFallbackCards(data: ExtendedCardData): Record<string, string> {
  const t = data.tci_scores;
  const h = data.matched_husband;
  const scorePercent = Math.round(data.match_score * 100);
  const topTCI = getTopTCIScores(t, 3);
  const bottomTCI = getBottomTCIScores(t, 2);
  const sortedCats = getSortedCategories(data.channel_categories);
  const characteristics = getTCICharacteristics(t);
  const mbtiTraits = getMBTITraits(data.mbti_scores);
  const enneaTrait = getEnneagramTrait(data.enneagram_type ?? 9);

  // YouTube ë¶„ì„ ë°ì´í„°
  const ytCats = data.youtubeCategories;
  const rarity = data.rarity;
  const topBottom = data.topBottom;
  const ytTCI = data.youtubeTCI;

  // íƒ€ì…ëª… ìƒì„±
  const typeNameMap: Record<string, Record<string, string>> = {
    'NS': { 'CO': 'ê±°ì¹¨ì—†ëŠ” ì‚¬êµí˜• íƒí—˜ê°€', 'SD': 'ììœ ë¡œìš´ ê°œì²™ì', 'ST': 'í˜¸ê¸°ì‹¬ ë§ì€ ì§€ì‹ íƒí—˜ê°€' },
    'ST': { 'SD': 'ê³ ë…í•œ ì§€ì  ë°©ë‘ì', 'CO': 'ë”°ëœ»í•œ ì² í•™ì', 'NS': 'í˜¸ê¸°ì‹¬ ë§ì€ ì§€ì‹ íƒí—˜ê°€' },
    'SD': { 'ST': 'ë…ë¦½ì ì¸ ì‚¬ìƒ‰ê°€', 'NS': 'ììœ ë¡œìš´ ê°œì²™ì', 'CO': 'ê· í˜• ì¡íŒ ë¦¬ë”' },
    'CO': { 'NS': 'í™œë°œí•œ ì—°ê²°ì', 'ST': 'ë”°ëœ»í•œ ì² í•™ì', 'SD': 'ê· í˜• ì¡íŒ ë¦¬ë”' },
    'P': { 'HA': 'ë¬µë¬µí•œ ì•ˆì • ì¶”êµ¬ì', 'SD': 'ëˆê¸° ìˆëŠ” ì„±ì·¨ì', 'CO': 'í—Œì‹ ì ì¸ ëŒë´„ì´' },
    'HA': { 'P': 'ì‹ ì¤‘í•œ ê³„íšê°€', 'CO': 'ì•ˆì „í•œ í’ˆ', 'ST': 'ì¡°ì‹¬ìŠ¤ëŸ¬ìš´ íƒêµ¬ì' },
  };
  const typeName = typeNameMap[topBottom.top1.axis]?.[topBottom.top2.axis] || 'ê· í˜• ì¡íŒ íƒí—˜ê°€';
  const englishType = `${topBottom.top1.name.replace(/[ê°€-í£]/g, '')} ${topBottom.top2.name.replace(/[ê°€-í£]/g, '')} Type`;

  return {
    "1": CARD_1_FIXED_CONTENT,

    "2_title": `ë‹¹ì‹ ì€ ${ytCats[0]?.name || 'ë‹¤ì–‘í•œ ê²½í—˜'}ì„ í†µí•´ ì„¸ìƒì„ íƒí—˜í•˜ëŠ” ì·¨í–¥ì„ ì§€ë‹ˆì…¨êµ°ìš”`,

    "2": `**ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ê°€ ë§í•´ì£¼ëŠ” ê²ƒ**

ì´ ${data.channelCount}ê°œì˜ ì±„ë„ì„ ë¶„ì„í•œ ê²°ê³¼, ${ytCats.length}ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ê³„ì‹  ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”. ì´ ìˆ«ìê°€ ì˜ë¯¸í•˜ëŠ” ë°”ê°€ ìˆìŠµë‹ˆë‹¤.

ê°€ì¥ ë§ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” ë¶„ì•¼ëŠ” "${ytCats[0]?.name || 'ë‹¤ì–‘í•¨'}"ìœ¼ë¡œ, ì „ì²´ì˜ ${ytCats[0]?.percent || 0}%ë¥¼ ì°¨ì§€í•˜ê³  ìˆì–´ìš”. ë‘ ë²ˆì§¸ëŠ” "${ytCats[1]?.name || 'ê¸°íƒ€'}"(${ytCats[1]?.percent || 0}%), ì„¸ ë²ˆì§¸ëŠ” "${ytCats[2]?.name || 'ê¸°íƒ€'}"(${ytCats[2]?.percent || 0}%)ì…ë‹ˆë‹¤.

ì´ ì¡°í•©ì€ ë‹¨ìˆœíˆ "ì´ëŸ° ì˜ìƒì„ ì¢‹ì•„í•œë‹¤"ëŠ” ê²ƒì„ ë„˜ì–´, ë‹¹ì‹ ì´ ë¬´ì˜ì‹ì ìœ¼ë¡œ ì¶”êµ¬í•˜ëŠ” ê°€ì¹˜ì™€ ìš•êµ¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. êµ¬ë… ë²„íŠ¼ì€ ìƒê°ë³´ë‹¤ ì •ì§í•˜ê±°ë“ ìš”.


**ìœ¡ê°í˜• ë°¸ëŸ°ìŠ¤ì—ì„œ ë“œëŸ¬ë‚œ ë‹¹ì‹ ì˜ íŠ¹ì„±**

ì €í¬ëŠ” ë‹¹ì‹ ì˜ êµ¬ë… ë°ì´í„°ë¥¼ 6ê°€ì§€ ì‹¬ë¦¬ì  ì¶•ìœ¼ë¡œ ë¶„ì„í•´ë³´ì•˜ì–´ìš”:

â€¢ ìê¸°ì´ˆì›”: ${ytTCI.ST}ì  - ì‚¶ì˜ ì˜ë¯¸ì™€ ê¹Šì´ë¥¼ ì¶”êµ¬í•˜ëŠ” ì •ë„
â€¢ ììœ¨ì„±: ${ytTCI.SD}ì  - ìŠ¤ìŠ¤ë¡œ ê²°ì •í•˜ê³  ì´ëŒì–´ê°€ë ¤ëŠ” ì„±í–¥
â€¢ ìê·¹ì¶”êµ¬: ${ytTCI.NS}ì  - ìƒˆë¡œìš´ ê²½í—˜ê³¼ ìê·¹ì— ëŒ€í•œ ìš•êµ¬
â€¢ ìœ„í—˜íšŒí”¼: ${ytTCI.HA}ì  - ì•ˆì „ê³¼ ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ì •ë„
â€¢ ì¸ë‚´ë ¥: ${ytTCI.P}ì  - ëª©í‘œë¥¼ í–¥í•´ ê¾¸ì¤€íˆ ë‚˜ì•„ê°€ëŠ” í˜
â€¢ ì—°ëŒ€ê°: ${ytTCI.CO}ì  - íƒ€ì¸ê³¼ì˜ ì—°ê²°ì„ ì¤‘ì‹œí•˜ëŠ” ì •ë„


**ê°€ì¥ ë‘ë“œëŸ¬ì§„ ì¶•: ${topBottom.top1.name} (${topBottom.top1.score}ì )**

ë‹¹ì‹ ì—ê²Œì„œ ê°€ì¥ ê°•í•˜ê²Œ ë‚˜íƒ€ë‚˜ëŠ” íŠ¹ì„±ì€ "${topBottom.top1.name}"ì´ì—ìš”. ì´ íŠ¹ì„±ì´ ${ytCats[0]?.name || 'ì£¼ìš” ì¹´í…Œê³ ë¦¬'} ì±„ë„ì„ ${ytCats[0]?.percent || 0}%ë‚˜ êµ¬ë…í•˜ê²Œ ë§Œë“  ì´ìœ ì´ê¸°ë„ í•´ìš”.

ë‘ ë²ˆì§¸ë¡œ ë†’ì€ "${topBottom.top2.name}"(${topBottom.top2.score}ì )ê³¼ í•¨ê»˜ ì‹œë„ˆì§€ë¥¼ ë§Œë“¤ì–´ë‚´ìš”. ì´ ì¡°í•©ì€ í”í•˜ì§€ ì•Šì•„ìš”.


**ì™œ ì´ë ‡ê²Œ ë¶„ì„í–ˆëŠ”ì§€**

ì´ í•´ì„ì€ ë‹¨ìˆœí•œ ì¶”ì¸¡ì´ ì•„ë‹™ë‹ˆë‹¤. ${ytCats[0]?.name || 'ì£¼ìš”'} ì¹´í…Œê³ ë¦¬ ${ytCats[0]?.percent || 0}%, ${ytCats[1]?.name || 'ë³´ì¡°'} ì¹´í…Œê³ ë¦¬ ${ytCats[1]?.percent || 0}%ë¼ëŠ” êµ¬ë… ë¹„ìœ¨ì´ ${topBottom.top1.name} ${topBottom.top1.score}ì ì´ë¼ëŠ” ì‹¬ë¦¬ ì ìˆ˜ì™€ ì¼ê´€ë˜ê²Œ ì—°ê²°ë˜ê¸° ë•Œë¬¸ì— ì‹ ë¢°í•  ìˆ˜ ìˆì–´ìš”.`,

    "3_title": `ë‹¹ì‹ ì˜ êµ¬ë… ì·¨í–¥ì€ ìƒìœ„ ${rarity.percentile}%ì—ìš”`,

    "3": `**"ë‹¹ì‹ ì˜ ì„¸ìƒì€ ì˜¨í†µ ${ytCats[0]?.name || 'ë‹¤ì–‘í•¨'}ë¡œ ê°€ë“í•´ìš”"**

ë‹¹ì‹ ì€ ì´ ${data.channelCount}ê°œì˜ ì±„ë„ì„ êµ¬ë…í•˜ê³  ìˆì–´ìš”. ì´ ìˆ«ìëŠ” í•œêµ­ ìœ íŠœë¸Œ ì‚¬ìš©ì í‰ê· ê³¼ ë¹„êµí–ˆì„ ë•Œ ${data.channelCount > 30 ? 'ìƒë‹¹íˆ ë§ì€' : data.channelCount > 15 ? 'í‰ê· ì ì¸' : 'ì„ ë³„ì ì¸'} í¸ì´ì—ìš”.


**ğŸ“Š ì¹´í…Œê³ ë¦¬ ë­í‚¹**

${ytCats.slice(0, 5).map((cat, i) =>
  `${i + 1}ìœ„: ${cat.name} â€” ${cat.count}ê°œ (${cat.percent}%) ${generateBarChart(cat.percent)}`
).join('\n')}


**1ìœ„: ${ytCats[0]?.name || 'ê¸°íƒ€'} (${ytCats[0]?.percent || 0}%)**

${ytCats[0]?.name || 'ë‹¤ì–‘í•œ'} ì¹´í…Œê³ ë¦¬ê°€ 1ìœ„ë¼ëŠ” ê±´ ë‹¹ì‹ ì˜ ì¼ìƒì—ì„œ ì´ ë¶„ì•¼ê°€ í° ë¹„ì¤‘ì„ ì°¨ì§€í•œë‹¤ëŠ” ì˜ë¯¸ì˜ˆìš”. ë‹¨ìˆœí•œ ì·¨ë¯¸ê°€ ì•„ë‹ˆë¼, ë‹¹ì‹ ì˜ ê°€ì¹˜ê´€ê³¼ ê´€ì‹¬ì‚¬ê°€ ì—¬ê¸°ì— ì§‘ì¤‘ë˜ì–´ ìˆì–´ìš”.


**2ìœ„: ${ytCats[1]?.name || 'ê¸°íƒ€'} (${ytCats[1]?.percent || 0}%)**

1ìœ„ì™€ 2ìœ„ì˜ ì¡°í•©ì´ íŠ¹íˆ í¥ë¯¸ë¡œì›Œìš”. ${ytCats[0]?.name || ''}ì˜ ${ytCats[0]?.percent || 0}%ì™€ ${ytCats[1]?.name || ''}ì˜ ${ytCats[1]?.percent || 0}%ê°€ ë§Œë‚˜ë©´, ë‹¹ì‹ ë§Œì˜ ë…íŠ¹í•œ ì·¨í–¥ ì‹œê·¸ë‹ˆì²˜ê°€ ë§Œë“¤ì–´ì ¸ìš”.


**3~5ìœ„ ë¶„ì„**

${ytCats.slice(2, 5).map(cat => `â€¢ ${cat.name}: ${cat.count}ê°œ (${cat.percent}%) - ë³´ì¡°ì  ê´€ì‹¬ì‚¬`).join('\n') || 'â€¢ ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ê°€ ë¶„ì‚°ë˜ì–´ ìˆì–´ìš”'}


**ì´ ì¡°í•©ì„ ê°€ì§„ ì‚¬ëŒì€ ëŒ€í•œë¯¼êµ­ ìœ íŠœë¸Œ ì‚¬ìš©ì ì¤‘ ìƒìœ„ ${rarity.percentile}%ì—ìš”**

ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ë¶„ì„ ê²°ê³¼, ë‹¹ì‹ ì˜ êµ¬ë… íŒ¨í„´ì€ í‰ê· ì—ì„œ ${rarity.cosineSimilarity < 0.7 ? 'ìƒë‹¹íˆ' : rarity.cosineSimilarity < 0.85 ? 'ê½¤' : 'ë‹¤ì†Œ'} ë²—ì–´ë‚˜ ìˆì–´ìš”. ì´ê±´ ë‹¹ì‹ ì´ ëŒ€ì¤‘ì ì¸ ì·¨í–¥ì„ ë”°ë¼ê°€ê¸°ë³´ë‹¤ ìì‹ ë§Œì˜ ê´€ì‹¬ì‚¬ë¥¼ ê¹Šì´ íŒŒê³ ë“œëŠ” ì‚¬ëŒì´ë¼ëŠ” ëœ»ì´ì—ìš”.

ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ëŠ” ë‹¹ì‹ ë§Œì˜ ì‹œê·¸ë‹ˆì²˜ì˜ˆìš”.`,

    "4": `**ê°€ì¥ í¬ê·€í•œ êµ¬ë… ì¹´í…Œê³ ë¦¬: ${rarity.rarestCategoryName}**

ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ì—ì„œ ê°€ì¥ ëˆˆì— ë„ëŠ” ê±´ "${rarity.rarestCategoryName}" ì¹´í…Œê³ ë¦¬ì˜ˆìš”.

ì´ ì¹´í…Œê³ ë¦¬ë¥¼ êµ¬ë…í•˜ëŠ” ì‚¬ìš©ìëŠ” ì „ì²´ í•œêµ­ ìœ íŠœë¸Œ ì‚¬ìš©ìì˜ **${Math.round(YOUTUBE_AVERAGE_RATIOS[rarity.rarestCategory as keyof typeof YOUTUBE_AVERAGE_RATIOS] * 100 * 10) / 10}%**ì— ë¶ˆê³¼í•´ìš”. í•˜ì§€ë§Œ ë‹¹ì‹ ì€ ì´ ë¶„ì•¼ì— ${rarity.rarestCategoryPercent}%ì˜ ê´€ì‹¬ì„ ë³´ì´ê³  ìˆì£ .


**í•´ë‹¹ ì±„ë„ ëª©ë¡:**

${rarity.rarestCategoryChannels.map(ch => `â€¢ ${ch}`).join('\n') || 'â€¢ (ì±„ë„ ì •ë³´ ì—†ìŒ)'}


**ì´ ì·¨í–¥ì´ ë§í•´ì£¼ëŠ” ë‹¹ì‹ ì˜ ì‹¬ë¦¬**

${rarity.rarestCategoryName} ì¹´í…Œê³ ë¦¬ë¥¼ êµ¬ë…í•œë‹¤ëŠ” ê±´ ë‹¨ìˆœí•œ ì·¨ë¯¸ ì´ìƒì˜ ì˜ë¯¸ê°€ ìˆì–´ìš”.

${rarity.rarestCategory === 'asmr' ?
'ASMRì„ ì¦ê¸°ëŠ” ì‚¬ëŒë“¤ì€ ì¼ìƒì—ì„œ ë°›ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í•´ì†Œí•˜ê³ , ì¡°ìš©í•œ í™˜ê²½ì—ì„œ ë§ˆìŒì˜ í‰í™”ë¥¼ ì°¾ìœ¼ë ¤ëŠ” ìš•êµ¬ê°€ ê°•í•´ìš”. ê°ê°ì  ë¯¼ê°ì„±ì´ ë†’ê³ , ë¯¸ë¬˜í•œ ìê·¹ì—ë„ ë°˜ì‘í•˜ëŠ” ì„¬ì„¸í•œ ê°ìˆ˜ì„±ì„ ê°€ì§€ê³  ìˆì–´ìš”.' :
rarity.rarestCategory === 'pets' ?
'ë°˜ë ¤ë™ë¬¼ ì½˜í…ì¸ ë¥¼ ì¦ê¸°ëŠ” ì‚¬ëŒë“¤ì€ ë¬´ì¡°ê±´ì ì¸ ì‚¬ë‘ê³¼ ìˆœìˆ˜í•œ ê´€ê³„ì— ëŒ€í•œ ê°ˆë§ì´ ìˆì–´ìš”. ëŒë´„ ë³¸ëŠ¥ì´ ê°•í•˜ê³ , ì§„ì •ì„± ìˆëŠ” ì—°ê²°ì„ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” ë¶„ì´ì—ìš”.' :
rarity.rarestCategory === 'finance' ?
'íˆ¬ì/ì¬í…Œí¬ ì½˜í…ì¸ ë¥¼ ì¦ê¸°ëŠ” ì‚¬ëŒë“¤ì€ ë¯¸ë˜ì— ëŒ€í•œ ê³„íšì„±ì´ ë›°ì–´ë‚˜ê³ , ê²½ì œì  ì•ˆì •ì„ ì¤‘ìš”í•˜ê²Œ ì—¬ê²¨ìš”. ìˆ«ìì™€ ë…¼ë¦¬ì— ê°•í•˜ê³ , ì¥ê¸°ì ì¸ ì‹œì•¼ë¡œ ì¸ìƒì„ ë°”ë¼ë³´ëŠ” ë¶„ì´ì—ìš”.' :
rarity.rarestCategory === 'travel' ?
'ì—¬í–‰ ì½˜í…ì¸ ë¥¼ ì¦ê¸°ëŠ” ì‚¬ëŒë“¤ì€ ìƒˆë¡œìš´ ê²½í—˜ì— ëŒ€í•œ ê°ˆë§ì´ í¬ê³ , ì¼ìƒì—ì„œ ë²—ì–´ë‚˜ ììœ ë¥¼ ëŠë¼ê³  ì‹¶ì€ ìš•êµ¬ê°€ ìˆì–´ìš”. í˜¸ê¸°ì‹¬ì´ ë§ê³ , ì—´ë¦° ë§ˆìŒìœ¼ë¡œ ì„¸ìƒì„ íƒí—˜í•˜ëŠ” ë¶„ì´ì—ìš”.' :
'ì´ ë¶„ì•¼ì— ê´€ì‹¬ì„ ê°€ì§„ë‹¤ëŠ” ê±´ ë‹¹ì‹ ë§Œì˜ ë…íŠ¹í•œ ê°€ì¹˜ê´€ê³¼ ì„¸ê³„ê´€ì´ ìˆë‹¤ëŠ” ëœ»ì´ì—ìš”. ëŒ€ì¤‘ì ì¸ ì½˜í…ì¸ ì— ë§Œì¡±í•˜ì§€ ì•Šê³ , ìì‹ ë§Œì˜ ì·¨í–¥ì„ ê°œì²™í•´ë‚˜ê°€ëŠ” ë¶„ì´ì‹œë„¤ìš”.'}


**ë‹¹ì‹ ë§Œì˜ ì‹œê·¸ë‹ˆì²˜**

${data.channelCount}ê°œ ì±„ë„ ì¤‘ ë‹¨ ${rarity.rarestCategoryChannels.length}ê°œ.
ê·¸ê²Œ ë‹¹ì‹ ì˜ ì‹œê·¸ë‹ˆì²˜ì˜ˆìš”.

ë§ì€ ì‚¬ëŒë“¤ì´ ë¹„ìŠ·í•œ ì±„ë„ì„ êµ¬ë…í•˜ê³  ë¹„ìŠ·í•œ ì˜ìƒì„ ë³´ì§€ë§Œ, ë‹¹ì‹ ì€ ë‹¬ë¼ìš”. ì´ í¬ê·€í•œ ì·¨í–¥ì´ ë‹¹ì‹ ì„ íŠ¹ë³„í•˜ê²Œ ë§Œë“œëŠ” ê±°ì˜ˆìš”.`,

    "5_subtitle": englishType.replace(/\s+/g, ' ').trim() || "Balanced Explorer Type",

    "5_title": `ë‹¹ì‹ ì€ ${typeName} íƒ€ì…ì´ì—ìš”`,

    "5": `#${topBottom.top1.name} #${topBottom.top2.name} #ìê¸°ì´í•´


**ë‹¹ì‹ ì˜ í•µì‹¬ íŠ¹ì„±: ${topBottom.top1.name}ê³¼ ${topBottom.top2.name}ì˜ ì¡°í™”**

ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•œ ê²°ê³¼, "${topBottom.top1.name}"ê³¼ "${topBottom.top2.name}"ì´ ê°€ì¥ ë‘ë“œëŸ¬ì§€ëŠ” íŠ¹ì„±ìœ¼ë¡œ ë‚˜íƒ€ë‚¬ì–´ìš”.

${topBottom.top1.name}ì´ ${topBottom.top1.score}ì ìœ¼ë¡œ ê°€ì¥ ë†’ì•„ìš”. ì´ê±´ ë‹¹ì‹ ì´ ${
topBottom.top1.axis === 'NS' ? 'ìƒˆë¡œìš´ ê²½í—˜ê³¼ ìê·¹ì„ ì¶”êµ¬í•˜ê³ , ë³€í™”ë¥¼ ì¦ê¸°ë©°, í˜¸ê¸°ì‹¬ì´ ë„˜ì¹˜ëŠ”' :
topBottom.top1.axis === 'ST' ? 'ì‚¶ì˜ ì˜ë¯¸ì™€ ê¹Šì´ë¥¼ ì¶”êµ¬í•˜ê³ , ì˜ì ì´ê±°ë‚˜ ì² í•™ì ì¸ ì‚¬ê³ ë¥¼ ì¦ê¸°ëŠ”' :
topBottom.top1.axis === 'SD' ? 'ìŠ¤ìŠ¤ë¡œ ê²°ì •í•˜ê³  ì´ëŒì–´ê°€ë©°, ë…ë¦½ì ìœ¼ë¡œ í–‰ë™í•˜ëŠ” ê²ƒì„ ì¤‘ìš”ì‹œí•˜ëŠ”' :
topBottom.top1.axis === 'CO' ? 'íƒ€ì¸ê³¼ì˜ ì—°ê²°ì„ ì¤‘ìš”ì‹œí•˜ê³ , ê³µë™ì²´ ì˜ì‹ì´ ê°•í•˜ë©° ë°°ë ¤ì‹¬ì´ ê¹Šì€' :
topBottom.top1.axis === 'P' ? 'ëª©í‘œë¥¼ í–¥í•´ ê¾¸ì¤€íˆ ë‚˜ì•„ê°€ë©°, ì–´ë ¤ì›€ì—ë„ í¬ê¸°í•˜ì§€ ì•ŠëŠ” ëˆê¸° ìˆëŠ”' :
'ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ í™˜ê²½ì„ ì„ í˜¸í•˜ë©°, ì‹ ì¤‘í•˜ê²Œ í–‰ë™í•˜ëŠ”'
} ë¶„ì´ë¼ëŠ” ëœ»ì´ì—ìš”.

ë‘ ë²ˆì§¸ë¡œ ë†’ì€ ${topBottom.top2.name}(${topBottom.top2.score}ì )ê³¼ í•¨ê»˜í•˜ë©´, ë‹¹ì‹ ë§Œì˜ ë…íŠ¹í•œ ì¡°í•©ì´ ì™„ì„±ë¼ìš”.


**ê´€ê³„ì—ì„œ ë³´ì´ëŠ” íŒ¨í„´**

ë¶„ì„ ê²°ê³¼, ë‹¹ì‹ ì€ ${mbtiTraits[0]} íŠ¹ì„±ì´ ìˆì–´ìš”. ê´€ê³„ì—ì„œë„ ì´ íŠ¹ì„±ì´ ê·¸ëŒ€ë¡œ ë“œëŸ¬ë‚˜ìš”.

${data.mbti_scores.E > data.mbti_scores.I ?
'ë‹¹ì‹ ì€ ì‚¬ëŒë“¤ ì†ì—ì„œ ë¹›ë‚˜ëŠ” íƒ€ì…ì´ì—ìš”. ìƒˆë¡œìš´ ì‚¬ëŒì„ ë§Œë‚˜ëŠ” ê²ƒì„ ë‘ë ¤ì›Œí•˜ì§€ ì•Šê³ , ëŒ€í™”ë¥¼ ì´ëŒì–´ê°€ëŠ” ëŠ¥ë ¥ë„ ìˆì–´ìš”. í•˜ì§€ë§Œ ê·¸ë ‡ë‹¤ê³  ì•„ë¬´ë‚˜ ê°€ê¹Œì´í•˜ëŠ” ê±´ ì•„ë‹ˆì—ìš”. ë§ì€ ì‚¬ëŒê³¼ êµë¥˜í•˜ë©´ì„œë„ ì§„ì •ìœ¼ë¡œ ë§ˆìŒì„ ì—¬ëŠ” ì‚¬ëŒì€ ì†Œìˆ˜ì˜ˆìš”.' :
'ë‹¹ì‹ ì€ ê¹Šì€ ê´€ê³„ë¥¼ ì„ í˜¸í•˜ëŠ” íƒ€ì…ì´ì—ìš”. ë§ì€ ì‚¬ëŒê³¼ í”¼ìƒì ìœ¼ë¡œ ì–´ìš¸ë¦¬ê¸°ë³´ë‹¤, ì†Œìˆ˜ì˜ ì‚¬ëŒê³¼ ì§„ì •í•œ ì—°ê²°ì„ ë§ºëŠ” ê²ƒì„ ë” ê°€ì¹˜ ìˆê²Œ ì—¬ê²¨ìš”.'}


**ìˆ¨ê²¨ì§„ ìš•êµ¬**

${enneaTrait} íŠ¹ì„±ì´ ë‘ë“œëŸ¬ì§€ëŠ” ë‹¹ì‹ , ì´ íŠ¹ì„± ë’¤ì—ëŠ” ìˆ¨ê²¨ì§„ ìš•êµ¬ê°€ ìˆì–´ìš”. ${
topBottom.bottom.axis === 'HA' ? 'ë‹¹ì‹ ì€ ì•ˆì „í•¨ë³´ë‹¤ ììœ ì™€ ëª¨í—˜ì„ ì¶”êµ¬í•´ìš”. í•˜ì§€ë§Œ ê°€ë”ì€ ì•ˆì •ê°ì„ ëŠë¼ê³  ì‹¶ì„ ë•Œë„ ìˆì£ .' :
topBottom.bottom.axis === 'CO' ? 'ë‹¹ì‹ ì€ ë…ë¦½ì ì´ì§€ë§Œ, ë§ˆìŒ ê¹Šì€ ê³³ì—ì„œëŠ” ì§„ì •í•œ ì—°ê²°ì„ ì›í•˜ê³  ìˆì–´ìš”.' :
topBottom.bottom.axis === 'NS' ? 'ë‹¹ì‹ ì€ ì•ˆì •ì„ ì¶”êµ¬í•˜ì§€ë§Œ, ê°€ë”ì€ ìƒˆë¡œìš´ ìê·¹ì´ í•„ìš”í•  ë•Œê°€ ìˆì–´ìš”.' :
'ë‹¹ì‹ ë§Œì˜ ë°©ì‹ìœ¼ë¡œ ì„¸ìƒê³¼ ì†Œí†µí•˜ê³  ìˆì§€ë§Œ, ë” ê¹Šì€ ì´í•´ë¥¼ ì›í•˜ê³  ìˆì–´ìš”.'}


**ì™œ ì´ë ‡ê²Œ ë¶„ì„í–ˆëŠ”ì§€**

â€¢ ${ytCats[0]?.name || ''} ${ytCats[0]?.percent || 0}% â†’ ${topBottom.top1.name} ë†’ìŒ
â€¢ ${ytCats[1]?.name || ''} ${ytCats[1]?.percent || 0}% â†’ ${topBottom.top2.name} ë†’ìŒ
â€¢ ${topBottom.bottom.name} ${topBottom.bottom.score}ì  (ìƒëŒ€ì  ì €ì ) â†’ ì´ ì˜ì—­ì€ ëœ ì¤‘ìš”ì‹œí•¨`,

    "6": `**ë‹¹ì‹ ì˜ ê°ì„± ìœ í˜•: "${t.RD >= 50 ? 'ë§ˆìŒì„ ë‚˜ëˆ„ë©° íë§í•˜ëŠ” ì‚¬ëŒ' : 'ì¡°ìš©íˆ ì •ë¦¬í•˜ë©° íë§í•˜ëŠ” ì‚¬ëŒ'}"**


**ê°ì • ì²˜ë¦¬ ë°©ì‹**

ë‹¹ì‹ ì€ í˜ë“¤ ë•Œ ${t.RD >= 50 ? 'ì‹ ë¢°í•˜ëŠ” ì‚¬ëŒê³¼ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ë©°' : 'í˜¼ìë§Œì˜ ì‹œê°„ì„ ê°€ì§€ë©°'} ê°ì •ì„ ì²˜ë¦¬í•˜ëŠ” í¸ì´ì—ìš”.

${t.HA >= 50 ? 'ê°ì •ì„ ì‹ ì¤‘í•˜ê²Œ ë‹¤ë£¨ê³ , ì„£ë¶ˆë¦¬ í‘œí˜„í•˜ê¸°ë³´ë‹¤ ì¶©ë¶„íˆ ì •ë¦¬í•œ í›„ì— ë‚˜ëˆ„ëŠ”' : 'ê°ì •ì— ì†”ì§í•˜ê³ , ì¦‰ê°ì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ”'} ê²½í–¥ì´ ìˆì–´ìš”.

ì´ê±´ ë‹¹ì‹ ë§Œì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë°©ì‹ì´ì—ìš”. ${t.RD >= 50 ? 'ë‹¤ë¥¸ ì‚¬ëŒê³¼ì˜ ì—°ê²°ì„ í†µí•´ ìœ„ë¡œë°›ëŠ”' : 'ìì‹ ë§Œì˜ ê³µê°„ì—ì„œ ì—ë„ˆì§€ë¥¼ ì¶©ì „í•˜ëŠ”'} ê²ƒì´ ë‹¹ì‹ ì—ê²ŒëŠ” ê°€ì¥ íš¨ê³¼ì ì¸ íë§ ë°©ë²•ì´ê±°ë“ ìš”.

íŠ¹íˆ ë‹¹ì‹ ì˜ êµ¬ë… ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ë©´, ${ytCats.find(c => c.category === 'music') ? 'ìŒì•… ê´€ë ¨ ì±„ë„ì´ ìˆì–´ì„œ ìŒì•…ìœ¼ë¡œ ê°ì •ì„ ì¡°ì ˆí•˜ëŠ”' : ytCats.find(c => c.category === 'asmr') ? 'ASMR ì±„ë„ì´ ìˆì–´ì„œ ì¡°ìš©í•œ ìê·¹ìœ¼ë¡œ ì•ˆì •ì„ ì°¾ëŠ”' : 'ë‹¤ì–‘í•œ ì½˜í…ì¸ ë¡œ ê¸°ë¶„ ì „í™˜ì„ í•˜ëŠ”'} íŒ¨í„´ì´ ë³´ì—¬ìš”.


**ë‹¹ì‹ ë§Œì˜ íë§ íŒ¨í„´**

âœ“ ${t.HA >= 50 ? 'í˜ë“¤ ë•Œ ë¨¼ì € í˜¼ì ì •ë¦¬í•˜ëŠ” ì‹œê°„ì´ í•„ìš”í•¨' : 'í˜ë“¤ ë•Œ ë°”ë¡œ ëˆ„êµ°ê°€ì™€ ì´ì•¼ê¸°í•˜ê³  ì‹¶ì–´í•¨'}
âœ“ ${t.RD >= 50 ? 'ê³µê° ë°›ìœ¼ë©´ í¬ê²Œ ìœ„ë¡œê°€ ë¨' : 'ì¡°ì–¸ë³´ë‹¤ ê·¸ëƒ¥ ë“¤ì–´ì£¼ëŠ” ê²Œ ë” ì¢‹ìŒ'}
âœ“ ${t.ST >= 50 ? 'ì˜ë¯¸ë¥¼ ì°¾ìœ¼ë©° ìƒí™©ì„ ì´í•´í•˜ë ¤ í•¨' : 'ì‹¤ìš©ì ì¸ í•´ê²°ì±…ì„ ë¨¼ì € ì°¾ìŒ'}
âœ“ ${ytCats.find(c => c.category === 'music') ? 'ìŒì•…ìœ¼ë¡œ ê°ì •ì„ ì¡°ì ˆí•¨' : 'ì·¨ë¯¸ í™œë™ìœ¼ë¡œ ê¸°ë¶„ ì „í™˜í•¨'}
âœ“ ${t.CO >= 50 ? 'ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒê³¼ í•¨ê»˜ ìˆëŠ” ê²ƒë§Œìœ¼ë¡œ íë§ë¨' : 'í˜¼ìë§Œì˜ ì·¨ë¯¸ ì‹œê°„ì´ ìµœê³ ì˜ íë§'}


**ì´ê±´ ì•½ì ì´ ì•„ë‹ˆì—ìš”**

${t.RD >= 50 ? 'ê°ì •ì— ë¯¼ê°í•œ' : 'í˜¼ì ì‹œê°„ì´ í•„ìš”í•œ'} ë‹¹ì‹ ì˜ íŠ¹ì„±ì€ ì•½ì ì´ ì•„ë‹ˆì—ìš”. ${t.RD >= 50 ? 'ì˜¤íˆë ¤ ê¹Šì€ ê³µê° ëŠ¥ë ¥ê³¼ ë”°ëœ»í•œ ë§ˆìŒì„ ê°€ì¡Œë‹¤ëŠ” ì˜ë¯¸ì˜ˆìš”.' : 'ì˜¤íˆë ¤ ìê¸° ìì‹ ì„ ì˜ ëŒë³¼ ì¤„ ì•ˆë‹¤ëŠ” ì˜ë¯¸ì˜ˆìš”.'}


**ê·¼ê±°**

â€¢ ${topBottom.top1.name} ${topBottom.top1.score}ì  â†’ ê°ì • ì²˜ë¦¬ì˜ í•µì‹¬ ì¶•
â€¢ ${ytCats[0]?.name} ${ytCats[0]?.percent}% êµ¬ë… â†’ ì´ ë¶„ì•¼ì—ì„œ ê°ì •ì  ë§Œì¡±ê°ì„ ì–»ìŒ`,

    "7": `**ë‹¹ì‹ ì´ ê¿ˆê¾¸ëŠ” ë¯¸ë˜: "${t.SD >= 50 ? 'ììœ ë¡­ê²Œ ì¼í•˜ë©° ì˜ë¯¸ ìˆëŠ” ì‚¶' : 'ì•ˆì •ì ì´ê³  ë”°ëœ»í•œ ì¼ìƒ'}"**


**3ì¶• ë¶„ì„**

ë¼ì´í”„ìŠ¤íƒ€ì¼: ${t.HA >= 50 ? 'â—â—â—â—â—‹ ì•ˆì •ì ' : 'â—â—â—â—‹â—‹ ìœ ì—°í•¨'}
ì»¤ë¦¬ì–´: ${t.SD >= 50 ? 'â—â—â—â—â— ìê¸°ì£¼ë„ì ' : 'â—â—â—â—â—‹ í˜‘ë ¥ì '}
ê´€ê³„: ${t.CO >= 50 ? 'â—â—â—â—â—‹ ì—°ê²° ì¤‘ì‹œ' : 'â—â—â—â—‹â—‹ ë…ë¦½ì '}


**ë¯¸ë˜ì˜ ì–´ëŠ ì €ë…**

ë‹¹ì‹ ì´ ê·¸ë¦¬ëŠ” ë¯¸ë˜ì˜ ì–´ëŠ ì €ë…ì„ ìƒìƒí•´ë³¼ê²Œìš”.

${t.SD >= 50 && t.ST >= 50 ?
`ë„“ì§€ ì•Šì•„ë„ ì¢‹ì€, ì‘ì§€ë§Œ ì•„ëŠ‘í•œ ê³µê°„. ì°½ë°–ìœ¼ë¡œëŠ” í•´ê°€ ì§€ëŠ” í’ê²½ì´ ë³´ì´ê³ , ë‹¹ì‹ ì€ ì˜¤ëŠ˜ í•˜ë£¨ ì˜ë¯¸ ìˆê²Œ ë³´ë‚¸ ì‹œê°„ì„ ë˜ëŒì•„ë³´ê³  ìˆì–´ìš”.

í…Œì´ë¸” ìœ„ì—ëŠ” ì¢‹ì•„í•˜ëŠ” ìŒë£Œì™€ ì•„ì§ ë‹¤ ì½ì§€ ëª»í•œ ì±…ì´ ë†“ì—¬ ìˆì–´ìš”. ì¡°ìš©í•œ ìŒì•…ì´ íë¥´ê³ , ë‹¹ì‹ ì€ ì´ ìˆœê°„ì˜ í‰í™”ë¡œì›€ì„ ì˜¨ì „íˆ ëŠë¼ê³  ìˆì–´ìš”.

í•˜ì§€ë§Œ ê·¸ ì˜†ì—ëŠ” í•¨ê»˜ ì´ ì‹œê°„ì„ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ” ì‚¬ëŒì´ ìˆìœ¼ë©´ ë” ì¢‹ê² ì£ .` :
t.CO >= 50 ?
`ë”°ëœ»í•œ ì¡°ëª… ì•„ë˜, ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì €ë… ì‹œê°„. ë§›ìˆëŠ” ìŒì‹ê³¼ í•¨ê»˜ ë‚˜ëˆ„ëŠ” ì†Œì†Œí•œ ì¼ìƒ ì´ì•¼ê¸°.

ì›ƒìŒì†Œë¦¬ê°€ ëŠì´ì§€ ì•Šê³ , ê°€ë”ì€ ì§„ì§€í•œ ëŒ€í™”ë„ ë‚˜ëˆ ìš”. ì´ ìˆœê°„ì˜ ì—°ê²°ê°ì´ ë‹¹ì‹ ì—ê²ŒëŠ” ê°€ì¥ í° í–‰ë³µì´ì—ìš”.` :
`ììœ ë¡­ê³  í™œê¸°ì°¬ ë¶„ìœ„ê¸°ì˜ ê³µê°„. ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥´ê³ , ë‹¹ì‹ ì€ ê·¸ê²ƒì„ ë©”ëª¨í•˜ê³  ìˆì–´ìš”.

ë‚´ì¼ì€ ë˜ ì–´ë–¤ ìƒˆë¡œìš´ ì¼ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”? ê·¸ ê¸°ëŒ€ê°ì´ ë‹¹ì‹ ì„ ì„¤ë ˆê²Œ í•´ìš”.`}


**ì‹¬ë¦¬ íŠ¹ì„±ì´ ë§í•´ì£¼ëŠ” ìš•êµ¬**

${topBottom.top1.name} ${topBottom.top1.score}ì : ì´ íŠ¹ì„±ì´ ë‹¹ì‹ ì˜ ë¯¸ë˜ìƒì„ ê²°ì •í•´ìš”
${topBottom.top2.name} ${topBottom.top2.score}ì : ë³´ì™„ì ìœ¼ë¡œ ì‘ìš©í•˜ë©° ê· í˜•ì„ ë§Œë“¤ì–´ìš”


**ê·¼ê±°**

â€¢ ${ytCats.find(c => c.category === 'education' || c.category === 'finance') ? 'êµìœ¡/ì¬í…Œí¬ ì½˜í…ì¸  êµ¬ë… â†’ ì„±ì¥ ì§€í–¥ì  ë¯¸ë˜ê´€' : 'ë‹¤ì–‘í•œ ì½˜í…ì¸  êµ¬ë… â†’ ì—´ë¦° ë¯¸ë˜ê´€'}
â€¢ ${topBottom.top1.name} ë†’ìŒ â†’ ì´ ë°©í–¥ì˜ ë¯¸ë˜ë¥¼ ì¶”êµ¬`,

    "8": `**ë‹¹ì‹ ì´ ê°€ì¥ í˜ë“¤ì–´í•˜ëŠ” ìƒëŒ€ë°©ì˜ ëª¨ìŠµ**

âš ï¸ "${t.ST >= 50 ? 'í”¼ìƒì ì´ê³  ê¹Šì´ ì—†ëŠ” ëŒ€í™”' : t.HA >= 50 ? 'ê¸‰ì‘ìŠ¤ëŸ½ê³  ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë³€í™”' : 'ì§€ë‚˜ì¹œ ê°ì • í‘œí˜„'}"


**ì™œ ì´ê²ƒì´ í˜ë“ ê°€ìš”?**

${t.ST >= 50 ?
`ë‹¹ì‹ ì€ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì™€ ì˜ë¯¸ ìˆëŠ” ì—°ê²°ì„ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” ë¶„ì´ì—ìš”.

ê·¸ë˜ì„œ "ì˜¤ëŠ˜ ë­ í–ˆì–´?" "ë³„ì¼ ì—†ì–´"ë¡œ ëë‚˜ëŠ” ëŒ€í™”ê°€ ë°˜ë³µë˜ë©´, ë§ˆìŒì´ ì ì  ë©€ì–´ì§€ëŠ” ê±¸ ëŠë¼ì‹œì£ .

ë‹¹ì‹ ì—ê²Œ ëŒ€í™”ëŠ” ë‹¨ìˆœí•œ ì •ë³´ êµí™˜ì´ ì•„ë‹ˆì—ìš”. ì„œë¡œì˜ ë‚´ë©´ì„ ë‚˜ëˆ„ê³ , ë” ê¹Šì´ ì•Œì•„ê°€ëŠ” ê³¼ì •ì´ê±°ë“ ìš”.` :
t.HA >= 50 ?
`ë‹¹ì‹ ì€ ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ í™˜ê²½ì„ ì„ í˜¸í•˜ëŠ” ë¶„ì´ì—ìš”.

ê·¸ë˜ì„œ ê°‘ìê¸° ê³„íšì´ ë°”ë€Œê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©ì´ ìƒê¸°ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ìœ¼ì‹œì£ .

ì´ê±´ ë‹¹ì‹ ì´ ìœ ì—°í•˜ì§€ ëª»í•´ì„œê°€ ì•„ë‹ˆì—ìš”. ì¶©ë¶„í•œ ì¤€ë¹„ì™€ ê³„íšì„ í†µí•´ ìµœì„ ì˜ ê²°ê³¼ë¥¼ ë‚´ê³  ì‹¶ì€ ë§ˆìŒì´ í° ê±°ì˜ˆìš”.` :
`ë‹¹ì‹ ì€ ë…ë¦½ì ì´ê³  ìê¸° ì£¼ê´€ì´ ëšœë ·í•œ ë¶„ì´ì—ìš”.

ê·¸ë˜ì„œ ìƒëŒ€ë°©ì´ ì§€ë‚˜ì¹˜ê²Œ ê°ì •ì— í˜¸ì†Œí•˜ê±°ë‚˜, ì˜ì¡´ì ì¸ ëª¨ìŠµì„ ë³´ì´ë©´ ë¶€ë‹´ì„ ëŠë¼ì‹œì£ .`}


**êµ¬ì²´ì  ìƒí™© ì˜ˆì‹œ**

| í˜ë“  ìƒí™© | ë‹¹ì‹ ì˜ ë‚´ë©´ |
| ${t.ST >= 50 ? '"ë³„ì¼ ì—†ì–´"ë¡œ ëŒ€í™” ë§ˆë¬´ë¦¬' : t.HA >= 50 ? 'ê°‘ìê¸° ì•½ì† ì·¨ì†Œ' : 'ë§¤ì¼ ê°ì • í† ë¡œ'} | ${t.ST >= 50 ? '"ë” ì•Œê³  ì‹¶ì€ë°..."' : t.HA >= 50 ? '"ë¯¸ë¦¬ ë§í•´ì¤¬ìœ¼ë©´..."' : '"ë‚˜ë„ ì‰¬ê³  ì‹¶ì–´..."'} |
| ${t.ST >= 50 ? 'í•­ìƒ ê°™ì€ ì£¼ì œì˜ ëŒ€í™”' : t.HA >= 50 ? 'ì¦‰í¥ì ì¸ ê³„íš ì œì•ˆ' : 'ì˜ì¡´ì ì¸ ê²°ì • ìš”ì²­'} | ${t.ST >= 50 ? '"ë” ê¹Šì´ ë‚˜ëˆ„ê³  ì‹¶ì–´"' : t.HA >= 50 ? '"ìƒê°í•  ì‹œê°„ì´ í•„ìš”í•´"' : '"ìŠ¤ìŠ¤ë¡œ ê²°ì •í•´ë´"'} |


**ì´ê±´ ì•½ì ì´ ì•„ë‹ˆì—ìš”**

${t.ST >= 50 ? 'ê¹Šì´ ìˆëŠ” ê´€ê³„ë¥¼ ì›í•˜ëŠ” ê²ƒ' : t.HA >= 50 ? 'ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ” ê²ƒ' : 'ë…ë¦½ì„±ì„ ì¤‘ì‹œí•˜ëŠ” ê²ƒ'}ì€ ë‹¹ì‹ ì˜ ê°•ì ì´ì—ìš”.

ìƒëŒ€ë°©ì—ê²Œ ë‹¹ì‹ ì˜ í•„ìš”ë¥¼ ë¶€ë“œëŸ½ê²Œ ì•Œë ¤ì£¼ì„¸ìš”. ì¢‹ì€ ê´€ê³„ëŠ” ì„œë¡œì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ëŠ” ê²ƒì—ì„œ ì‹œì‘í•´ìš”.


**ê·¼ê±°**

â€¢ ${topBottom.top1.name} ${topBottom.top1.score}ì  â†’ ì´ ì˜ì—­ì—ì„œ ë¯¼ê°í•¨
â€¢ ${topBottom.bottom.name} ${topBottom.bottom.score}ì  â†’ ë°˜ëŒ€ íŠ¹ì„±ì— ë¶ˆí¸í•¨`,

    "9": `**ë‹¹ì‹ ì˜ ì™•ìë‹˜ì€**

"${h.variant === 'extrovert' ? h.metaphor_e : h.metaphor_i}"


**${h.category} - ${h.subcategory}**

ì´ ìœ í˜•ì€ ${h.description}


**ì²˜ìŒ ë§Œë‚¬ì„ ë•Œ**

ì²˜ìŒ ë§Œë‚¬ì„ ë•Œ ${h.variant === 'extrovert' ? 'ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ì—ë„ˆì§€ê°€ ëŠê»´ì§ˆ ê±°ì˜ˆìš”. ëŒ€í™”ë¥¼ ì´ëŒì–´ê°€ê³ , ë‹¹ì‹ ì„ í¸ì•ˆí•˜ê²Œ ë§Œë“¤ì–´ì£¼ëŠ” ì‚¬ëŒ.' : 'ì¡°ìš©í•˜ì§€ë§Œ ê¹Šì´ ìˆëŠ” ì¸ìƒì„ ë°›ì„ ê±°ì˜ˆìš”. ë§ì€ ë§ì§€ ì•Šì§€ë§Œ, í•œë§ˆë”” í•œë§ˆë””ì— ë¬´ê²Œê°ì´ ìˆëŠ” ì‚¬ëŒ.'}

ëŒ€í™”ë¥¼ ë‚˜ëˆŒìˆ˜ë¡ "ì´ ì‚¬ëŒ, ${h.variant === 'extrovert' ? 'ìƒê°ë³´ë‹¤ ê¹Šì€ ë©´ì´ ìˆêµ¬ë‚˜' : 'ì•Œìˆ˜ë¡ ë§¤ë ¥ ìˆëŠ” ì‚¬ëŒì´êµ¬ë‚˜'}"ë¼ëŠ” ê±¸ ëŠë¼ê²Œ ë  ê±°ì˜ˆìš”.

ê³µí†µì˜ ê´€ì‹¬ì‚¬ë¥¼ ë°œê²¬í–ˆì„ ë•Œì˜ ë°˜ì§ì„, ì„œë¡œì˜ ê°€ì¹˜ê´€ì´ ë§ë‹¿ëŠ” ìˆœê°„ì˜ ì„¤ë ˜... ê·¸ëŸ° ê²ƒë“¤ì´ ì¡°ê¸ˆì”© ìŒ“ì—¬ê°ˆ ê±°ì˜ˆìš”.


**ì™œ ì´ ìœ í˜•ì¸ê°€ìš”?**

ë‹¹ì‹ ì˜ ${topBottom.top1.name}ì´ ${topBottom.top1.score}ì ìœ¼ë¡œ ë†’ì•„ìš”. ì´ëŸ° ë¶„ì—ê²ŒëŠ” ${h.variant === 'extrovert' ? 'í•¨ê»˜ ì„±ì¥í•˜ê³  ì„œë¡œë¥¼ ìê·¹í•˜ëŠ”' : 'ê¹Šì´ ì´í•´í•˜ê³  ì„œë¡œì˜ ê³µê°„ì„ ì¡´ì¤‘í•˜ëŠ”'} íŒŒíŠ¸ë„ˆê°€ ì˜ ë§ì•„ìš”.

${h.name}ì€ ë‹¹ì‹ ì˜ ${topBottom.top1.name}ì„ ì¸ì •í•´ì£¼ê³ , ${topBottom.bottom.name}ì„ ë³´ì™„í•´ì¤„ ìˆ˜ ìˆëŠ” ìœ í˜•ì´ì—ìš”.


**ê·¼ê±°**

â€¢ ë§¤ì¹­ ì ìˆ˜: ${scorePercent}%
â€¢ ${topBottom.top1.name} ${topBottom.top1.score}ì  â†’ ì´ ìœ í˜•ê³¼ ë†’ì€ ìƒì„±`,

    "10": `**ë‹¹ì‹ ì˜ ì™•ìë‹˜ í”„ë¡œí•„**


**ê¸°ë³¸ ì •ë³´**

ìœ í˜•: ${h.name}
ì¹´í…Œê³ ë¦¬: ${h.category} - ${h.subcategory}
ì„±í–¥: ${h.variant === 'extrovert' ? 'ì™¸í–¥í˜•' : 'ë‚´í–¥í˜•'}
ë§¤ì¹­ ì ìˆ˜: ${scorePercent}%


**ì´ëŸ° ë¶„ì´ì—ìš”**

${h.description}

${h.variant === 'extrovert' ?
'í™œë°œí•˜ê³  ì—ë„ˆì§€ê°€ ë„˜ì¹˜ëŠ” ë¶„ì´ì—ìš”. ìƒˆë¡œìš´ ì‚¬ëŒì„ ë§Œë‚˜ê³ , ìƒˆë¡œìš´ ê²½í—˜ì„ í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”. í•˜ì§€ë§Œ ê·¸ ì•ˆì— ê¹Šì´ë„ ìˆì–´ì„œ, ì§„ì§€í•œ ëŒ€í™”ë„ ì¶©ë¶„íˆ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ” ë¶„ì´ì£ .' :
'ì¡°ìš©í•˜ì§€ë§Œ ë‚´ë©´ì´ í’ë¶€í•œ ë¶„ì´ì—ìš”. ê¹Šì€ ìƒê°ê³¼ í’ë¶€í•œ ê°ì„±ì„ ê°€ì§€ê³  ìˆì–´ìš”. ì²˜ìŒì—ëŠ” ë‹¤ê°€ê°€ê¸° ì–´ë ¤ì›Œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, ì•Œë©´ ì•Œìˆ˜ë¡ ë§¤ë ¥ì´ ìˆëŠ” ë¶„ì´ì£ .'}


**í•¨ê»˜í•˜ë©´ ì´ëŸ° ëª¨ìŠµì´ì—ìš”**

ã€ì¥ë©´ 1ã€‘ ì£¼ë§ ì˜¤í›„
${h.variant === 'extrovert' ?
'ìƒˆë¡œìš´ ì¹´í˜ë‚˜ ë§›ì§‘ì„ í•¨ê»˜ íƒí—˜í•˜ë©° ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ë‚´ìš”.' :
'ê°ì ì¢‹ì•„í•˜ëŠ” ì±…ì„ ì½ê±°ë‚˜, ì¡°ìš©íˆ í•¨ê»˜ ìˆëŠ” ì‹œê°„.'}

ã€ì¥ë©´ 2ã€‘ í˜ë“  ë‚ 
${h.variant === 'extrovert' ?
'ë‹¹ì‹ ì˜ ê¸°ë¶„ì„ ê¸ˆë°© ì•Œì•„ì±„ê³ , í•¨ê»˜ ë§›ìˆëŠ” ê²ƒì„ ë¨¹ìœ¼ëŸ¬ ê°€ìê³  í•´ìš”.' :
'ì¡°ìš©íˆ ì˜†ì— ìˆì–´ì¤˜ìš”. ê·¸ ì¡´ì¬ë§Œìœ¼ë¡œ ìœ„ë¡œê°€ ë¼ìš”.'}

ã€ì¥ë©´ 3ã€‘ íŠ¹ë³„í•œ ë‚ 
${h.variant === 'extrovert' ?
'ê¹œì§ ì´ë²¤íŠ¸ë‚˜ ì„œí”„ë¼ì´ì¦ˆë¥¼ ì¢‹ì•„í•´ìš”.' :
'ì‘ì§€ë§Œ ì˜ë¯¸ ìˆëŠ” ì„ ë¬¼ì´ë‚˜ í¸ì§€ë¥¼ ì¤€ë¹„í•´ìš”.'}


**ì•Œì•„ë‘ì„¸ìš”**

${h.variant === 'extrovert' ?
'ì´ ìœ í˜•ì€ í˜¼ìë§Œì˜ ì‹œê°„ë³´ë‹¤ í•¨ê»˜í•˜ëŠ” ì‹œê°„ì„ ì„ í˜¸í•´ìš”.' :
'ì´ ìœ í˜•ì€ ìê¸°ë§Œì˜ ì‹œê°„ê³¼ ê³µê°„ì´ í•„ìš”í•´ìš”.'}`,

    "11": `ì—¬ê¸°ê¹Œì§€ê°€ ë¬´ë£Œ ë¶„ì„ì´ì—ìš”.

ë‹¹ì‹ ì˜ êµ¬ë… ì±„ë„ ${data.channelCount}ê°œë¥¼ ë¶„ì„í•´ 11ì¥ì˜ ì¹´ë“œë¡œ ë‹¹ì‹ ì˜ ë‚´ë©´ì„ ë“¤ì—¬ë‹¤ë³´ì•˜ì–´ìš”.


**ğŸ”® Phase 2ì—ì„œ ì•Œ ìˆ˜ ìˆëŠ” ê²ƒ**

ë” ê¹Šì€ ì´ì•¼ê¸°ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.

âœ¦ ì• ì¸ì´ ìƒê°í•˜ëŠ” ë‹¹ì‹ 
  â†’ "ì¡°ìš©í•œ ë°”ë‹¤ ê°™ì€ ì‚¬ëŒ â€” ê¹Šì´ë¥¼..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ë‹¹ì‹ ì´ ê²°í˜¼ì„ í™•ì‹ í•˜ê²Œ ë˜ëŠ” ìˆœê°„
  â†’ "ë‹¹ì‹ ì—ê²Œ ê²°í˜¼ì˜ í™•ì‹ ì€..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ì—°ì• ì—ì„œ ê²°í˜¼ìœ¼ë¡œ ëª» ê°€ëŠ” ì§„ì§œ ì´ìœ 
  â†’ "ë°˜ë³µë˜ëŠ” íŒ¨í„´ì´..." [ë¸”ëŸ¬ ì²˜ë¦¬]

âœ¦ ë§Œì•½ ì´í˜¼í•œë‹¤ë©´, ê·¸ ì´ìœ ëŠ”...
  â†’ "ìœ„í—˜ ìš”ì¸ ë¶„ì„ ê²°ê³¼..." [ë¸”ëŸ¬ ì²˜ë¦¬]


**ğŸ“ Phase 2 ì§„í–‰ ë°©ì‹**

1. 9ê°œì˜ ì‹¬ì¸µ ì§ˆë¬¸ì— ë‹µë³€
2. YouTube ë°ì´í„°ì™€ êµì°¨ ê²€ì¦
3. 8ì¥ì˜ ì‹¬ì¸µ ë¦¬í¬íŠ¸ ì¹´ë“œ ì œê³µ


**[ ğŸ’ ì‹¬ì¸µ ë¶„ì„ ì‹œì‘í•˜ê¸° â€” â‚©4,900 ]**


* ë¶„ì„ ê²°ê³¼ëŠ” ì‹¬ë¦¬í•™ì  ì—°êµ¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì§€ë§Œ,
  ì‹¤ì œ ì‹¬ë¦¬ ê²€ì‚¬ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* ì¬ë¯¸ì™€ ìê¸° ì´í•´ë¥¼ ìœ„í•œ ì½˜í…ì¸ ë¡œ ì¦ê²¨ì£¼ì„¸ìš”.`,
  };
}

export interface Phase1Precomputed {
  channel_categories: Awaited<ReturnType<typeof categorizeChannels>>;
  tci_scores: ReturnType<typeof calculateTCI>;
  enneagram_center: ReturnType<typeof estimateEnneagram>['center'];
  enneagram_type: number;
  mbti_scores: ReturnType<typeof estimateMBTI>['scores'];
  mbti_type: string;
  user_vector: number[];
  channelCount: number;
}

/**
 * Run full Phase 1 pipeline from ChannelData[] and insert result.
 */
export async function runPhase1FromChannels(
  supabase: SupabaseClient,
  userId: string,
  channels: ChannelData[]
): Promise<{ phase1_id: string }> {
  const channel_categories = await categorizeChannels(channels);
  const tci_scores = calculateTCI(channel_categories);
  const enneagram = estimateEnneagram(tci_scores, channel_categories);
  const mbti = estimateMBTI(tci_scores, channel_categories);
  const user_vector = createVector(tci_scores, enneagram.center, channel_categories);
  const channelCount = channels.length;

  // YouTube ë¶„ì„ ì‹¤í–‰
  const youtubeAnalysis = await runYouTubeAnalysis(channels);

  return runPhase1FromPrecomputed(supabase, userId, {
    channel_categories,
    tci_scores,
    enneagram_center: enneagram.center,
    enneagram_type: enneagram.type,
    mbti_scores: mbti.scores,
    mbti_type: mbti.type,
    user_vector,
    channelCount,
  }, youtubeAnalysis);
}

/**
 * Run Phase 1 card generation + insert from precomputed analysis.
 */
export async function runPhase1FromPrecomputed(
  supabase: SupabaseClient,
  userId: string,
  data: Phase1Precomputed,
  youtubeAnalysis?: {
    categoryResults: YouTubeCategoryResult[];
    rarity: RarityAnalysis;
    tciScores: YouTubeTCIScores;
    topBottom: ReturnType<typeof import('@/lib/husband-match/analysis/youtube-analysis').getTopBottomAxes>;
  }
): Promise<{ phase1_id: string }> {
  const {
    channel_categories,
    tci_scores,
    enneagram_center,
    enneagram_type,
    mbti_scores,
    mbti_type,
    user_vector,
    channelCount,
  } = data;

  const matchResult = matchHusbandType(
    user_vector,
    mbti_scores,
    enneagram_type
  );

  // YouTube ë¶„ì„ ë°ì´í„° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
  const ytAnalysis = youtubeAnalysis || {
    categoryResults: [
      { category: 'entertainment' as const, name: 'ì˜ˆëŠ¥/ë²„ë¼ì´ì–´í‹°', count: 5, percent: 30, color: '#FF6B6B' },
      { category: 'vlog' as const, name: 'ë¸Œì´ë¡œê·¸/ì¼ìƒ', count: 3, percent: 20, color: '#4ECDC4' },
    ],
    rarity: {
      percentile: 25,
      rarestCategory: 'travel' as const,
      rarestCategoryName: 'ì—¬í–‰',
      rarestCategoryPercent: 10,
      rarestCategoryChannels: ['ì±„ë„1'],
      cosineSimilarity: 0.8,
    },
    tciScores: { ST: 50, SD: 50, NS: 50, HA: 50, P: 50, CO: 50 },
    topBottom: {
      top1: { axis: 'NS' as const, score: 60, name: 'ìê·¹ì¶”êµ¬' },
      top2: { axis: 'CO' as const, score: 55, name: 'ì—°ëŒ€ê°' },
      bottom: { axis: 'HA' as const, score: 30, name: 'ìœ„í—˜íšŒí”¼' },
    },
  };

  const extendedCardData: ExtendedCardData = {
    channelCount,
    channel_categories,
    tci_scores,
    enneagram_center,
    enneagram_type,
    mbti_scores,
    mbti_type,
    matched_husband: matchResult.type,
    match_score: matchResult.score,
    youtubeCategories: ytAnalysis.categoryResults,
    rarity: ytAnalysis.rarity,
    youtubeTCI: ytAnalysis.tciScores,
    topBottom: ytAnalysis.topBottom,
  };

  // ì¹´ë“œ ì½˜í…ì¸  ìƒì„±
  let cardContents: Record<string, string>;
  try {
    cardContents = await generateAllCardsAtOnce(extendedCardData);
    // LLMì´ ìƒì„±í•´ì•¼ í•  ì¹´ë“œ: 2,3,4,5,6,7,8,9,10 = 9ì¥ (+ íƒ€ì´í‹€ í‚¤ 3ê°œ = ìµœì†Œ 12ê°œ í‚¤)
    if (!cardContents || Object.keys(cardContents).length < 8) {
      console.log('[Phase 1] Incomplete AI response, using fallback');
      cardContents = generateFallbackCards(extendedCardData);
    }
  } catch (err) {
    console.error('[Phase 1] Card generation failed, using fallback:', err);
    cardContents = generateFallbackCards(extendedCardData);
  }

  // 11ì¥ ì¹´ë“œ ìƒì„±
  const cards: ReportCard[] = [];
  for (let cardNumber = 1; cardNumber <= 11; cardNumber++) {
    const meta = CARD_TITLES[cardNumber];
    const cardKey = String(cardNumber);

    // ì¹´ë“œë³„ content ê²°ì • (ì¹´ë“œ 1, 11ì€ ê³ ì • í…ìŠ¤íŠ¸)
    let content: string;
    if (cardNumber === 1) {
      content = CARD_1_FIXED_CONTENT;
    } else if (cardNumber === 11) {
      content = getCard11FixedContent(channelCount);
    } else {
      content = cardContents[cardKey] || 'ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }

    // ì¹´ë“œ 2, 3, 5ì˜ titleì€ LLM ì‘ë‹µì—ì„œ ê°€ì ¸ì˜´
    let title: string;
    if (cardNumber === 2) {
      title = cardContents['2_title'] || 'ë‹¹ì‹ ì˜ ì·¨í–¥ì„ ë¶„ì„í•´ë³´ì•˜ì–´ìš”';
    } else if (cardNumber === 3) {
      title = cardContents['3_title'] || `ë‹¹ì‹ ì˜ êµ¬ë… ì·¨í–¥ì€ ìƒìœ„ ${ytAnalysis.rarity.percentile}%ì—ìš”`;
    } else if (cardNumber === 5) {
      title = cardContents['5_title'] || 'ë‹¹ì‹ ì€ ê· í˜• ì¡íŒ íƒí—˜ê°€ íƒ€ì…ì´ì—ìš”';
    } else {
      title = meta.title;
    }

    // ì¹´ë“œ 5ì˜ subtitleë„ LLM ì‘ë‹µì—ì„œ
    let subtitle: string | undefined;
    if (cardNumber === 5) {
      subtitle = cardContents['5_subtitle'] || 'Balanced Explorer Type';
    } else {
      subtitle = meta.subtitle;
    }

    cards.push({
      card_number: cardNumber,
      title,
      subtitle,
      content: String(content).slice(0, 5000),
      card_type: meta.card_type,
    });
  }

  const payload = {
    user_id: userId,
    channel_categories,
    tci_scores,
    enneagram_center,
    enneagram_type,
    mbti_scores,
    mbti_type,
    user_vector,
    matched_husband_type: matchResult.type.id,
    match_score: matchResult.score,
    match_method: matchResult.method,
    cards,
  };

  const { data: result, error: insertError } = await supabase
    .from('phase1_results')
    .insert(payload)
    .select('id')
    .single();

  if (insertError) {
    console.error('Failed to store Phase 1 results:', insertError);
    throw new Error('Failed to store analysis results');
  }

  return { phase1_id: result.id };
}
